!function(t,s){"object"==typeof exports&&"undefined"!=typeof module?s(exports):"function"==typeof define&&define.amd?define(["exports"],s):s((t="undefined"!=typeof globalThis?globalThis:t||self).SnapLineJs={})}(this,(function(t){"use strict";var s,i,h,e,n,r,l,o,a,u,c,d,f,p,g,m,b,w,_,v,D,E,W,y,x,M,R,C,k,L,A,I,T,O,P,X,S=Object.defineProperty,j=t=>{throw TypeError(t)},Y=(t,s,i)=>((t,s,i)=>s in t?S(t,s,{enumerable:!0,configurable:!0,writable:!0,value:i}):t[s]=i)(t,"symbol"!=typeof s?s+"":s,i),$=(t,s,i)=>s.has(t)||j("Cannot "+i),F=(t,s,i)=>($(t,s,"read from private field"),i?i.call(t):s.get(t)),q=(t,s,i)=>s.has(t)?j("Cannot add the same private member more than once"):s instanceof WeakSet?s.add(t):s.set(t,i),U=(t,s,i,h)=>($(t,s,"write to private field"),h?h.call(t,i):s.set(t,i),i),z=(t,s,i)=>($(t,s,"access private method"),i);class G{constructor(t,m={}){q(this,s),q(this,i),q(this,h),q(this,e),q(this,n),q(this,r),q(this,l),q(this,o),q(this,a),q(this,u),q(this,c),q(this,d),q(this,f),q(this,p),q(this,g);let b=t.getBoundingClientRect();U(this,s,t),U(this,i,b.left),U(this,h,b.top),U(this,e,b.width),U(this,n,b.height),U(this,f,F(this,e)/2),U(this,p,F(this,n)/2),U(this,r,0),U(this,l,0),U(this,o,0),U(this,a,0),U(this,u,1);U(this,c,{enableZoom:!0,zoomBounds:{min:.2,max:1},enablePan:!0,panBounds:{top:null,left:null,right:null,bottom:null},...m}),U(this,d,""),this.updateCamera(),F(this,c).handleResize,U(this,g,new ResizeObserver((()=>{this.updateCameraProperty()}))),F(this,g).observe(F(this,s)),F(this,g).observe(window.document.body),window.addEventListener("scroll",(()=>{this.updateCamera()}))}get cameraWidth(){return F(this,e)}get cameraHeight(){return F(this,n)}get cameraPositionX(){return F(this,r)}get cameraPositionY(){return F(this,l)}get zoom(){return F(this,u)}get containerOffsetX(){return F(this,i)}get containerOffsetY(){return F(this,h)}updateCameraProperty(){let t=F(this,s).getBoundingClientRect();U(this,i,t.left),U(this,h,t.top),U(this,e,t.width),U(this,n,t.height),U(this,f,F(this,e)/2+F(this,r)),U(this,p,F(this,n)/2+F(this,l))}centerCamera(t,s){let i=F(this,r)-F(this,f)+t,h=F(this,l)-F(this,p)+s;U(this,r,i),U(this,l,h),this.updateCamera()}worldToCameraMatrix(t,s,i){return`${i},0,0,0,0,${i},0,0,0,0,1,0,${-t*i},${-s*i},0,1`}updateCamera(){const t=this.worldToCameraMatrix(F(this,r),F(this,l),F(this,u));U(this,d,`matrix3d(${t})`)}get canvasStyle(){return F(this,d)}setCameraPosition(t,s){U(this,r,t),U(this,l,s),this.updateCamera()}handleScroll(t,s,i){if(!F(this,c).enableZoom)return;F(this,u)+t<.2?t=.2-F(this,u):F(this,u)+t>1&&(t=1-F(this,u)),F(this,c).zoomBounds&&(F(this,u)+t<F(this,c).zoomBounds.min||F(this,u)+t>F(this,c).zoomBounds.max)&&(t=0);const h=F(this,u)/(F(this,u)+t);F(this,c).enablePan&&(U(this,r,F(this,r)-F(this,e)/F(this,u)*(h-1)*(1-(1.5*F(this,e)-s)/F(this,e))),U(this,l,F(this,l)-F(this,n)/F(this,u)*(h-1)*(1-(1.5*F(this,n)-i)/F(this,n)))),U(this,u,F(this,u)+t),this.updateCamera()}handlePan(t,s){F(this,c).enablePan&&(U(this,r,F(this,r)+t/F(this,u)),U(this,l,F(this,l)+s/F(this,u)),this.updateCamera())}handlePanStart(){F(this,c).enablePan&&(U(this,o,F(this,r)),U(this,a,F(this,l)))}handlePanDrag(t,s){F(this,c).enablePan&&(U(this,r,-t/F(this,u)+F(this,o)),U(this,l,-s/F(this,u)+F(this,a)),F(this,c).panBounds&&(null!==F(this,c).panBounds.left&&F(this,r)<F(this,c).panBounds.left&&U(this,r,F(this,c).panBounds.left+1),null!==F(this,c).panBounds.right&&F(this,r)>F(this,c).panBounds.right&&U(this,r,F(this,c).panBounds.right-1),null!==F(this,c).panBounds.top&&F(this,l)<F(this,c).panBounds.top&&U(this,l,F(this,c).panBounds.top-1),null!==F(this,c).panBounds.bottom&&F(this,l)>F(this,c).panBounds.bottom&&U(this,l,F(this,c).panBounds.bottom+1)),this.updateCamera())}handlePanEnd(){F(this,c).enablePan&&(U(this,o,0),U(this,a,0))}getCameraFromWorld(t,s){return[(t-F(this,r))*F(this,u),(s-F(this,l))*F(this,u)]}getScreenFromCamera(t,s){return[t+F(this,i),s+F(this,h)]}getWorldFromCamera(t,s){return[t/F(this,u)+F(this,r),s/F(this,u)+F(this,l)]}getCameraFromScreen(t,s){return[t-=F(this,i),s-=F(this,h)]}getCameraDeltaFromWorldDelta(t,s){return[t*F(this,u),s*F(this,u)]}getWorldDeltaFromCameraDelta(t,s){return[t/F(this,u),s/F(this,u)]}}function B(t,s){const i=s.getBoundingClientRect();if(null==t.camera)return{height:i.height,width:i.width,x:i.left,y:i.top,cameraX:i.left,cameraY:i.top,screenX:i.left,screenY:i.top};const[h,e]=t.camera.getCameraFromScreen(i.left,i.top),[n,r]=t.camera.getWorldFromCamera(h,e),[l,o]=t.camera.getCameraDeltaFromWorldDelta(i.width,i.height),[a,u]=t.camera.getWorldDeltaFromCameraDelta(l,o);return{height:u,width:a,x:n,y:r,cameraX:h,cameraY:e,screenX:i.left,screenY:i.top}}function Q(t){return`translate3d(${t.x}px, ${t.y}px, 0px) scale(${t.scaleX}, ${t.scaleY}) `}function N(t,s){Object.assign(t.style,s)}function H(t,s,i=null){return new Proxy(s,{set:(s,i,h)=>(s[i]=null==h?null:h.bind(t),!0),get:(t,s)=>(...h)=>{var e,n;null==(e=t[s])||e.call(t,...h),null==(n=null==i?void 0:i[s])||n.call(i,...h)}})}s=new WeakMap,i=new WeakMap,h=new WeakMap,e=new WeakMap,n=new WeakMap,r=new WeakMap,l=new WeakMap,o=new WeakMap,a=new WeakMap,u=new WeakMap,c=new WeakMap,d=new WeakMap,f=new WeakMap,p=new WeakMap,g=new WeakMap;class Z{constructor(t,s,i){Y(this,"owner"),Y(this,"keyframe"),Y(this,"property"),q(this,m),q(this,b),q(this,w),q(this,_),q(this,v),q(this,D),q(this,E),q(this,W),q(this,y),Y(this,"requestDelete"),this.owner=t,this.keyframe=s,this.property=i,U(this,b,null),U(this,y,!0),this.property.duration||(this.property.duration=1e3),this.property.delay||(this.property.delay=0);let h=0;for(const[l,o]of Object.entries(this.keyframe)){const t=Array.isArray(o)?o.length:1;h=Math.max(h,t)}if(this.property.offset)U(this,_,this.property.offset);else{U(this,_,[]);for(let t=0;t<h;t++)F(this,_).push(t/(h-1))}this.property.easing?Array.isArray(this.property.easing)?U(this,v,this.property.easing):U(this,v,[this.property.easing]):U(this,v,["linear"]),this.property.duration&&Array.isArray(this.property.duration)?U(this,D,this.property.duration):U(this,D,[this.property.duration]),this.property.delay?U(this,E,this.property.delay):U(this,E,0),U(this,m,{}),U(this,w,[]),U(this,W,Object.keys(this.keyframe).filter((t=>t.startsWith("$"))).length>0);let e={};for(const[l,o]of Object.entries(this.keyframe))l.startsWith("$")?F(this,m)[l]=o:e[l]=o;F(this,W)&&0==Object.keys(e).length&&(e={}),this.property.offset&&(e.offset=this.property.offset);const n=this.owner instanceof it?this.owner.t.element:this.owner.global.animationFragment,r={delay:F(this,E),fill:"both"};if(F(this,D).length>1?e.duration=F(this,D):r.duration=F(this,D)[0],F(this,v).length>1?e.easing=F(this,v):r.easing=F(this,v)[0],U(this,b,new Animation(new KeyframeEffect(n,e,r))),this.requestDelete=!1,F(this,b).onfinish=()=>{var t,s;null==(s=(t=this.property).finish)||s.call(t),this.finish(),F(this,b).cancel(),this.requestDelete=!0},U(this,w,[]),F(this,W)&&F(this,v).length>1)for(let l=0;l<F(this,_).length-1;l++){const t={};for(const[n,r]of Object.entries(F(this,m)))t[n]=r.slice(l,l+1);const s=(F(this,_)[l+1]-F(this,_)[l])*this.property.duration,i=F(this,_)[l]*this.property.duration+this.property.delay,h=F(this,v)[l],e=new Animation(new KeyframeEffect(n,t,{duration:s,delay:i,easing:h,fill:"both"}));e.onfinish=()=>{e.cancel()},e.persist(),F(this,w).push(e)}}pause(){F(this,b).pause();for(let t=0;t<F(this,w).length;t++)F(this,w)[t].pause()}play(){F(this,b).play();for(let t=0;t<F(this,w).length;t++)F(this,w)[t].play()}cancel(){F(this,b).cancel();for(let t=0;t<F(this,w).length;t++)F(this,w)[t].cancel()}reverse(){F(this,b).reverse();for(let t=0;t<F(this,w).length;t++)F(this,w)[t].reverse()}calculateFrame(t){var s,i,h,e;const n=F(this,b).effect.getComputedTiming().progress;if(null==n)return!1;const r=this.property.duration*n+this.property.delay;if(F(this,W)){let t=0;for(let s=0;s<F(this,_).length-1;s++)if(F(this,_)[s]<=n&&n<F(this,_)[s+1]){t=s;break}let h=n;if(F(this,v).length>1){const s=F(this,w)[t];s.currentTime=r,h=s.effect.getComputedTiming().progress??0}const e={};for(const[s,i]of Object.entries(F(this,m))){const n=i[t],r=n+(i[t+1]-n)*h;e[s]=r}null==(i=(s=this.property).tick)||i.call(s,e)}else null==(e=(h=this.property).tick)||e.call(h,{});return!1}finish(){var t;null==(t=F(this,b))||t.commitStyles()}set currentTime(t){F(this,b).currentTime=t;for(let s=0;s<F(this,w).length;s++)F(this,w)[s].currentTime=t}set progress(t){this.currentTime=(this.property.duration+this.property.delay)*t}}m=new WeakMap,b=new WeakMap,w=new WeakMap,_=new WeakMap,v=new WeakMap,D=new WeakMap,E=new WeakMap,W=new WeakMap,y=new WeakMap;class K{constructor(){Y(this,"animations"),Y(this,"startTime"),Y(this,"endTime"),Y(this,"expired"),Y(this,"requestDelete"),this.animations=[],this.startTime=-1,this.endTime=-1,this.expired=!1,this.requestDelete=!1}add(t){this.animations.push(t)}play(){for(let t=0;t<this.animations.length;t++)this.animations[t].play()}pause(){for(let t=0;t<this.animations.length;t++)this.animations[t].pause()}cancel(){for(let t=0;t<this.animations.length;t++)this.animations[t].cancel()}reverse(){for(let t=0;t<this.animations.length;t++)this.animations[t].reverse()}calculateFrame(t){let s=!1;for(let i=0;i<this.animations.length;i++)s=this.animations[i].calculateFrame(t)||s;return s}set currentTime(t){for(let s=0;s<this.animations.length;s++)this.animations[s].currentTime=t}set progress(t){for(let s=0;s<this.animations.length;s++)this.animations[s].progress=t}}let J=class{constructor(t){Y(this,"_object"),Y(this,"_global"),Y(this,"global"),Y(this,"_input"),Y(this,"input"),Y(this,"_dom"),Y(this,"dom"),this.i=t,this.h={pointerDown:null,pointerMove:null,pointerUp:null,mouseWheel:null,drag:null,pinch:null,dragStart:null,dragEnd:null,pinchStart:null,pinchEnd:null},this.global=new Proxy(this.h,{set:(t,s,i)=>{var h,e;return null==i?null==(h=this.i.global.inputEngine)||h.unsubscribeGlobalCursorEvent(s,this.i.gid):null==(e=this.i.global.inputEngine)||e.subscribeGlobalCursorEvent(s,this.i.gid,i.bind(this.i)),!0}}),this.l={pointerDown:null,pointerMove:null,pointerUp:null,mouseWheel:null,dragStart:null,drag:null,dragEnd:null,pinchStart:null,pinch:null,pinchEnd:null},this.input=H(this.i,this.l),this.t={onAssignDom:null,onResize:null},this.dom=H(this.i,this.t)}};class V{constructor(t,s,i=null){Y(this,"uuid"),Y(this,"object"),Y(this,"callback"),this.uuid=i??t.global.getGlobalId(),this.object=t,this.callback=s?[s.bind(t)]:null}addCallback(t){this.callback?this.callback.push(t.bind(this.object)):this.callback=[t.bind(this.object)]}}class tt{constructor(t,s){Y(this,"global"),Y(this,"gid"),Y(this,"parent"),Y(this,"children",[]),Y(this,"transform"),Y(this,"local"),Y(this,"offset"),Y(this,"event"),Y(this,"_requestPreRead",!1),Y(this,"_requestWrite",!1),Y(this,"_requestRead",!1),Y(this,"_requestDelete",!1),Y(this,"_requestPostWrite",!1),Y(this,"_colliderList",[]),Y(this,"_animationList",[]),Y(this,"_globalInput"),Y(this,"globalInput"),this.global=t,this.gid=t.getGlobalId(),this.global.objectTable[this.gid]=this,this.parent=s,this.o=[],this.transform={x:0,y:0,scaleX:1,scaleY:1},this.local={x:0,y:0,scaleX:1,scaleY:1},this.offset={x:0,y:0,scaleX:1,scaleY:1},this.event=new J(this),this.u=!1,this.p=!1,this.m=!1,this._=!1,this.v=!1,this.D={pointerDown:null,pointerMove:null,pointerUp:null,mouseWheel:null,dragStart:null,drag:null,dragEnd:null,pinchStart:null,pinch:null,pinchEnd:null},this.globalInput=new Proxy(this.D,{set:(t,s,i)=>{var h,e;return null==i?null==(h=this.global.inputEngine)||h.unsubscribeGlobalCursorEvent(s,this.gid):null==(e=this.global.inputEngine)||e.subscribeGlobalCursorEvent(s,this.gid,i.bind(this)),!0}})}destroy(){delete this.global.objectTable[this.gid]}get worldPosition(){return[this.transform.x,this.transform.y]}set worldPosition(t){this.transform.x=t[0],this.transform.y=t[1]}get cameraPosition(){var t;return(null==(t=this.global.camera)?void 0:t.getCameraFromWorld(...this.worldPosition))??[0,0]}set cameraPosition(t){var s;this.worldPosition=(null==(s=this.global.camera)?void 0:s.getWorldFromCamera(...t))??[0,0]}get screenPosition(){var t;return(null==(t=this.global.camera)?void 0:t.getScreenFromCamera(...this.cameraPosition))??[0,0]}set screenPosition(t){var s;this.cameraPosition=(null==(s=this.global.camera)?void 0:s.getCameraFromScreen(...t))??[0,0]}queueUpdate(t="READ_1",s=null,i=null){let h=new V(this,s,i),e=this.global.read1Queue;switch(t){case"READ_1":e=this.global.read1Queue;break;case"WRITE_1":e=this.global.write1Queue;break;case"READ_2":e=this.global.read2Queue;break;case"WRITE_2":e=this.global.write2Queue;break;case"READ_3":e=this.global.read3Queue;break;case"WRITE_3":e=this.global.write3Queue}return e[this.gid]||(e[this.gid]=new Map),e[this.gid].set(h.uuid,h),h}readDom(t=!1){for(const s of this.o)s.read()}writeDom(){}writeTransform(){}destroyDom(){}calculateLocalFromTransform(){this.parent&&(this.transform.x=this.parent.transform.x+this.local.x,this.transform.y=this.parent.transform.y+this.local.y);for(const t of this.o)t.recalculate()}animate(t,s){let i=new Z(this,t,s);for(const h of this.W)h.cancel();return this.W=[],this.W.push(i),this.global.animationList.push(i),i}get animation(){return this.W[0]}animateSequence(t){let s=new K;for(const i of t)s.add(i);return this.W=[],this.W.push(s),this.global.animationList.push(s),s}getCurrentStats(){return{timestamp:Date.now()}}addCollider(t){var s;this.o.push(t),null==(s=this.global.collisionEngine)||s.addObject(t)}addDebugPoint(t,s,i="red",h=!1,e=""){this.global.debugMarkerList[`${this.gid}-${e}`]={gid:this.gid,type:"point",color:i,x:t,y:s,persistent:h,id:`${this.gid}-${e}`}}addDebugRect(t,s,i,h,e="red",n=!1,r=""){this.global.debugMarkerList[`${this.gid}-${r}`]={gid:this.gid,type:"rect",color:e,x:t,y:s,width:i,height:h,persistent:n,id:`${this.gid}-${r}`}}addDebugCircle(t,s,i,h="red",e=!1,n=""){this.global.debugMarkerList[`${this.gid}-${n}`]={gid:this.gid,type:"circle",color:h,x:t,y:s,radius:i,persistent:e,id:`${this.gid}-${n}`}}addDebugText(t,s,i,h="red",e=!1,n=""){this.global.debugMarkerList[`${this.gid}-${n}`]={gid:this.gid,x:t,y:s,type:"text",color:h,text:i,persistent:e,id:`${this.gid}-${n}`}}clearDebugMarker(t){delete this.global.debugMarkerList[`${this.gid}-${t}`]}clearAllDebugMarkers(){for(const t of Object.values(this.global.debugMarkerList))t.gid==this.gid&&delete this.global.debugMarkerList[t.id]}}class st{constructor(t,s,i=null,h={},e=!1){Y(this,"_uuid"),Y(this,"_global"),Y(this,"_owner"),Y(this,"element"),Y(this,"_pendingInsert"),Y(this,"_requestWrite",!1),Y(this,"_requestRead",!1),Y(this,"_requestDelete",!1),Y(this,"_requestPostWrite",!1),Y(this,"_style"),Y(this,"_classList"),Y(this,"_dataAttribute"),Y(this,"property"),Y(this,"_transformApplied"),Y(this,"insertMode"),Y(this,"resizeObserver",null),Y(this,"mutationObserver",null),this.h=t,this.element=i,this.property={x:0,y:0,height:0,width:0,scaleX:1,scaleY:1,screenX:0,screenY:0},this.M={x:0,y:0,scaleX:1,scaleY:1},this.R=e,this.C=s,this.k=(++t.gid).toString(),this.p=!1,this.m=!1,this._=!1,this.v=!1,this.L={},this.A={},this.I=[],this.insertMode=h}addElement(t){this.element=t,this.C.requestWrite(),this.C.requestRead(),this.resizeObserver=new ResizeObserver((()=>{var t,s;null==(s=(t=this.C.event.dom).onResize)||s.call(t)})),this.resizeObserver.observe(t),this.mutationObserver=new MutationObserver((()=>{var t,s;null==(s=(t=this.C.event.dom).onResize)||s.call(t)}))}set style(t){this.L=Object.assign(this.L,t)}get style(){return this.L}set dataAttribute(t){this.A=Object.assign(this.A,t)}get dataAttribute(){return this.A}set classList(t){this.I=t}get classList(){return this.I}readDom(t=!1){if(!this.element)throw new Error("Element is not set");const s=B(this.h,this.element),i=this.element.style.transform;let h={x:0,y:0,scaleX:1,scaleY:1};i&&"none"!=i&&t&&(h=function(t){const s=t.split("(")[1].split(")")[0].split(",");return{x:parseFloat(s[0]),y:parseFloat(s[1]),scaleX:parseFloat(s[3])||1,scaleY:parseFloat(s[4])||1}}(i)),this.property.height=s.height/h.scaleY,this.property.width=s.width/h.scaleX,this.property.x=s.x-h.x,this.property.y=s.y-h.y,this.property.screenX=s.screenX,this.property.screenY=s.screenY}writeDom(){if(!this.element)throw new Error("Element is not set");N(this.element,this.L),this.element.classList.forEach((t=>{this.element.classList.add(t)}));for(const[t,s]of Object.entries(this.A))this.element.setAttribute(`data-${t}`,s);this.element.setAttribute("data-snapline-gid",this.C.gid)}writeTransform(){if(!this.element)throw new Error("Element is not set");let t={transform:""};if("direct"==this.C.transformMode)t={transform:Q({x:this.C.transform.x+this.C.offset.x,y:this.C.transform.y+this.C.offset.y,scaleX:this.C.transform.scaleX,scaleY:this.C.transform.scaleY})};else if("relative"==this.C.transformMode){let[s,i]=[this.C.transform.x-this.property.x,this.C.transform.y-this.property.y];t={transform:Q({x:s+this.C.offset.x,y:i+this.C.offset.y,scaleX:this.C.transform.scaleX,scaleY:this.C.transform.scaleY})}}else if("none"==this.C.transformMode)t={transform:""};else if("offset"==this.C.transformMode){if(!this.C.transformOrigin)throw new Error("Transform origin is not set");t={transform:Q({x:this.C.transform.x-this.C.transformOrigin.transform.x,y:this.C.transform.y-this.C.transformOrigin.transform.y,scaleX:this.C.transform.scaleX*this.C.transformOrigin.transform.scaleX,scaleY:this.C.transform.scaleY*this.C.transformOrigin.transform.scaleY})}}null!=this.L.transform&&""!=this.L.transform&&""!=t.transform&&(t.transform=this.L.transform),N(this.element,{...this.L,...t})}destroyDom(){var t,s;null==(t=this.resizeObserver)||t.disconnect(),null==(s=this.mutationObserver)||s.disconnect(),this.element&&this.element.remove()}}class it extends tt{constructor(t,s){super(t,s),Y(this,"_dom"),Y(this,"_requestWrite"),Y(this,"_requestRead"),Y(this,"_requestDelete"),Y(this,"_requestPostWrite"),Y(this,"_state",{}),Y(this,"state"),Y(this,"transformMode"),Y(this,"transformOrigin"),Y(this,"_domProperty"),Y(this,"inScene",!1),Y(this,"_callback"),Y(this,"callback"),Y(this,"inputEngine"),this.t=new st(t,this,null),this.inScene=!1,this.p=!1,this.m=!1,this._=!1,this.v=!1,this.T=[{x:0,y:0,height:0,width:0,scaleX:1,scaleY:1,screenX:0,screenY:0},{x:0,y:0,height:0,width:0,scaleX:1,scaleY:1,screenX:0,screenY:0},{x:0,y:0,height:0,width:0,scaleX:1,scaleY:1,screenX:0,screenY:0}],this.transformMode="direct",this.transformOrigin=null,this.O={afterRead1:null,afterRead2:null,afterRead3:null,afterWrite1:null,afterWrite2:null,afterWrite3:null},this.callback=H(this,this.O),this.state=new Proxy(this.P,{set:(t,s,i)=>(t[s]=i,!0)}),this.inputEngine=new et(this.global,!1,this.gid)}destroy(){this.t.destroyDom(),super.destroy()}getDomProperty(t=null){const s="READ_1"==t?0:"READ_2"==t?1:2;return this.T[s]}saveDomPropertyToTransform(t=null){let s=t??this.global.currentStage;s="IDLE"==s?"READ_2":s;const i=this.getDomProperty(s);this.transform.x=i.x,this.transform.y=i.y}calculateLocalFromTransform(){this.parent&&(this.local.x=this.transform.x-this.parent.transform.x,this.local.y=this.transform.y-this.parent.transform.y)}calculateLocalFromDom(t=null){if(this.parent){const s=this.getDomProperty(t);this.parent instanceof it?(this.local.x=s.x-this.parent.getDomProperty(t).x,this.local.y=s.y-this.parent.getDomProperty(t).y):(this.local.x=this.transform.x-this.parent.transform.x,this.local.y=this.transform.y-this.parent.transform.y)}}calculateTransformFromLocal(){this.parent&&(this.transform.x=this.parent.transform.x+this.local.x,this.transform.y=this.parent.transform.y+this.local.y)}get style(){return this.t.style}set style(t){this.t.style=t}get classList(){return this.t.classList}set classList(t){this.t.classList=t}get dataAttribute(){return this.t.dataAttribute}set dataAttribute(t){this.t.dataAttribute=t}get element(){return this.t.element}set element(t){var s,i,h,e;if(!t)return;this.t.addElement(t),null==(s=this.inputEngine)||s.addCursorEventListener(t);const n=Object.keys(this.inputEngine.event);for(const r of n){let t=(null==(i=this.event.input[r])?void 0:i.bind(this))||null;this.inputEngine.event[r]=t}null==(e=(h=this.event.dom).onAssignDom)||e.call(h)}readDom(t=!1,s=null){let i=s??this.global.currentStage;i="IDLE"==i?"READ_2":i,this.t.readDom(t),super.readDom(t),"READ_1"==i?Object.assign(this.T[0],this.t.property):"READ_2"==i?Object.assign(this.T[1],this.t.property):"READ_3"==i&&Object.assign(this.T[2],this.t.property)}writeDom(){this.t.writeDom(),super.writeDom()}writeTransform(){this.t.writeTransform(),super.writeTransform()}destroyDom(){this.t.destroyDom(),super.destroyDom()}requestRead(t=!1,s=!0,i="READ_1"){return this.queueUpdate(i,(()=>{this.readDom(t),s&&this.saveDomPropertyToTransform(i)}),i)}requestWrite(t=!0,s=null,i="WRITE_1"){return this.queueUpdate(i,(()=>{t&&this.writeDom(),null==s||s()}),i)}requestDestroy(){return this.queueUpdate("WRITE_2",(()=>{this.destroyDom()}),"destroy")}requestTransform(t="WRITE_2"){return this.queueUpdate(t,(()=>{this.writeTransform()}),"transform")}requestFLIP(t,s){this.requestRead(!1,!0,"READ_1"),this.requestWrite(!0,t,"WRITE_1"),this.requestRead(!1,!0,"READ_2"),this.requestWrite(!1,s,"WRITE_2")}}const ht="global";class et{constructor(t,s=!0,i=null){var h;q(this,R),Y(this,"_element"),Y(this,"global"),Y(this,"_sortedTouchArray"),Y(this,"_sortedTouchDict"),Y(this,"_localPointerDict"),Y(this,"_event"),Y(this,"event"),Y(this,"_isGlobal"),Y(this,"_uuid"),Y(this,"_ownerGID"),q(this,x),q(this,M),this.global=t,this.X=null,this.S=s,this.j=[],this.Y={},this.$=i,this.F={},U(this,M,[]),this.q={pointerDown:null,pointerMove:null,pointerUp:null,mouseWheel:null,dragStart:null,drag:null,dragEnd:null,pinchStart:null,pinch:null,pinchEnd:null},this.event=H(this,this.q,this.S?null:null==(h=this.globalInputEngine)?void 0:h.U.event),this.k=Symbol(),U(this,x,new tt(this.global,null))}destroy(){}get globalInputEngine(){var t;return null==(t=this.global)?void 0:t.inputEngine}get globalPointerDict(){return null==this.globalInputEngine?{}:this.globalInputEngine.G}get globalGestureDict(){return null==this.globalInputEngine?{}:this.globalInputEngine.B}getCoordinates(t,s){if(null==this.global)return{x:t,y:s,cameraX:t,cameraY:s,screenX:t,screenY:s};const[i,h]=this.global.camera.getCameraFromScreen(t,s),[e,n]=this.global.camera.getWorldFromCamera(i,h);return{x:e,y:n,cameraX:i,cameraY:h,screenX:t,screenY:s}}onPointerDown(t){var s,i,h,e;t.stopPropagation();const n=this.getCoordinates(t.clientX,t.clientY);null==(i=(s=this.event).pointerDown)||i.call(s,{event:t,position:n,gid:this.S?ht:this.$,button:t.buttons});const r={id:t.pointerId,callerGID:this.S?ht:this.$,timestamp:t.timeStamp,x:t.clientX,y:t.clientY,startX:t.clientX,startY:t.clientY,prevX:t.clientX,prevY:t.clientY,endX:null,endY:null,moveCount:0};this.globalPointerDict[t.pointerId]=r,null==(e=(h=this.event).dragStart)||e.call(h,{gid:this.S?ht:this.$,pointerId:t.pointerId,start:n,button:t.buttons}),F(this,x).addDebugPoint(n.x,n.y,"red",!0,"pointerDown"),this.globalGestureDict[t.pointerId]?this.globalGestureDict[t.pointerId].memberList.push(this):this.globalGestureDict[t.pointerId]={type:"drag",state:"drag",memberList:[this,...F(this,M)],initiatorID:this.S?ht:this.$??""}}onPointerMove(t){var s,i;t.preventDefault();const h=this.getCoordinates(t.clientX,t.clientY);null==(i=(s=this.event).pointerMove)||i.call(s,{event:t,position:h,gid:this.S?ht:this.$,button:t.buttons});const e=t.pointerId;let n=this.globalPointerDict[e];if(null!=n){const s={prevX:n.x,prevY:n.y,x:t.clientX,y:t.clientY,callerGID:this.S?ht:this.$};Object.assign(n,s),z(this,R,C).call(this,t)}t.stopPropagation()}onPointerUp(t){var s,i,h,e,n,r;t.preventDefault();const l=this.getCoordinates(t.clientX,t.clientY);null==(i=(s=this.event).pointerUp)||i.call(s,{event:t,position:l,gid:this.S?ht:this.$,button:t.buttons});let o=this.globalPointerDict[t.pointerId];if(null!=o){const s=this.globalGestureDict[t.pointerId];if(null!=s){s.state="release";const i=this.getCoordinates(o.startX,o.startY);for(const n of s.memberList)null==(e=(h=n.event).dragEnd)||e.call(h,{gid:this.S?ht:this.$,pointerId:t.pointerId,start:i,end:l,button:t.buttons});delete this.globalGestureDict[t.pointerId]}delete this.globalPointerDict[t.pointerId];for(const i of Object.keys(this.globalGestureDict)){if(!i.includes("-"))continue;const[s,h]=i.split("-").map(Number);if(s==t.pointerId||h==t.pointerId){const t=this.globalGestureDict[i];null==(r=(n=this.event).pinchEnd)||r.call(n,{gid:this.S?ht:this.$,gestureID:i,start:t.start,pointerList:t.pointerList,distance:t.distance,end:{pointerList:t.pointerList,distance:t.distance}}),delete this.globalGestureDict[i]}}}t.stopPropagation()}onWheel(t){var s,i;const h=this.getCoordinates(t.clientX,t.clientY);null==(i=(s=this.event).mouseWheel)||i.call(s,{event:t,position:h,delta:t.deltaY,gid:this.S?ht:this.$}),t.stopPropagation()}addListener(t,s,i){t.addEventListener(s,i.bind(this))}addCursorEventListener(t){this.addListener(t,"pointerdown",this.onPointerDown),this.addListener(t,"pointermove",this.onPointerMove),this.addListener(t,"pointerup",this.onPointerUp),this.addListener(t,"wheel",this.onWheel)}addDragMember(t){F(this,M).push(t)}resetDragMembers(){U(this,M,[])}}x=new WeakMap,M=new WeakMap,R=new WeakSet,C=function(t){var s,i,h,e,n,r;const l=Object.keys(this.globalPointerDict).length;if(l>=1)for(const o of Object.values(this.globalPointerDict)){if((this.S?ht:this.$)!=o.callerGID)continue;const h=this.getCoordinates(o.startX,o.startY),e=this.getCoordinates(o.x,o.y),n={x:e.x-h.x,y:e.y-h.y,cameraX:e.cameraX-h.cameraX,cameraY:e.cameraY-h.cameraY,screenX:e.screenX-h.screenX,screenY:e.screenY-h.screenY};o.moveCount,o.moveCount++;const r=this.globalGestureDict[o.id];for(const l of r.memberList)null==(i=(s=l.event).drag)||i.call(s,{gid:l.S?ht:l.$,pointerId:o.id,start:h,position:e,delta:n,button:t.buttons})}if(l>=2&&this.S){const t=Object.values(this.globalPointerDict);t.sort(((t,s)=>t.timestamp-s.timestamp));for(let s=0;s<t.length-1;s++){const i=t[s],l=t[s+1],o=`${i.id}-${l.id}`,a=(i.startX+l.startX)/2,u=(i.startY+l.startY)/2,c=(this.getCoordinates(a,u),Math.sqrt(Math.pow(i.startX-l.startX,2)+Math.pow(i.startY-l.startY,2))),d=this.getCoordinates(i.x,i.y),f=this.getCoordinates(l.x,l.y),p=Math.sqrt(Math.pow(i.x-l.x,2)+Math.pow(i.y-l.y,2));null==this.globalGestureDict[o]&&(this.globalGestureDict[o]={type:"pinch",state:"pinch",memberList:[this],start:{pointerList:[d,f],distance:c},pointerList:[d,f],distance:c},null==(e=(h=this.event).pinchStart)||e.call(h,{gid:this.S?ht:this.$,gestureID:o,start:{pointerList:[d,f],distance:c}}));const g=this.globalGestureDict[o];g.pointerList=[d,f],g.distance=p,null==(r=(n=this.event).pinch)||r.call(n,{gid:this.S?ht:this.$,gestureID:o,start:g.start,pointerList:g.pointerList,distance:g.distance})}}};class nt{constructor(t=null){q(this,k),Y(this,"global"),Y(this,"_inputControl"),Y(this,"globalCallbacks"),Y(this,"_pointerDict"),Y(this,"_gestureDict"),Y(this,"_event"),Y(this,"event"),this.global=t,U(this,k,document),this.U=new et(this.global,!0,null),this.U.addCursorEventListener(F(this,k)),this.globalCallbacks={pointerDown:{},pointerMove:{},pointerUp:{},mouseWheel:{},dragStart:{},drag:{},dragEnd:{},pinchStart:{},pinch:{},pinchEnd:{}},this.G={},this.B={};for(const[s,i]of Object.entries(this.globalCallbacks))this.U.event[s]=t=>{for(const i of Object.values(this.globalCallbacks[s]))i(t)};this.q={pointerDown:null,pointerMove:null,pointerUp:null,mouseWheel:null,dragStart:null,drag:null,dragEnd:null,pinchStart:null,pinch:null,pinchEnd:null},this.event=new Proxy(this.q,{set:(t,s,i)=>(null!=i?this.subscribeGlobalCursorEvent(s,ht,i.bind(this)):this.unsubscribeGlobalCursorEvent(s,ht),!0)})}subscribeGlobalCursorEvent(t,s,i){this.globalCallbacks[t][s]=i}unsubscribeGlobalCursorEvent(t,s){delete this.globalCallbacks[t][s]}}k=new WeakMap;class rt{constructor(t){Y(this,"_object"),Y(this,"_collider"),Y(this,"collider"),this.i=t,this.N={onCollide:null,onBeginContact:null,onEndContact:null},this.collider=H(t,this.N)}}class lt{constructor(t,s,i,h,e){Y(this,"global"),Y(this,"parent"),Y(this,"type"),Y(this,"uuid"),Y(this,"_element"),Y(this,"inputEngine"),Y(this,"transform"),Y(this,"event"),Y(this,"_currentCollisions"),Y(this,"_iterationCollisions"),this.global=t,this.parent=s,this.type=i,this.uuid=Symbol(),this.X=null,this.transform={x:h,y:e,width:0,height:0},this.event=new rt(this.parent),this.H=new Set,this.Z=new Set,this.recalculate(),this.inputEngine=new et(this.global)}get worldPosition(){return[this.parent.transform.x+this.transform.x,this.parent.transform.y+this.transform.y]}set worldPosition([t,s]){this.transform.x=t-this.parent.transform.x,this.transform.y=s-this.parent.transform.y}set element(t){this.X=t,this.parent.hasOwnProperty("element")?this.parent.requestRead():this.recalculate()}read(){if(!this.element)return;const t=B(this.global,this.element);this.transform.x=t.x-this.parent.transform.x,this.transform.y=t.y-this.parent.transform.y,this.transform.width=t.width,this.transform.height=t.height}recalculate(){}}class ot extends lt{constructor(t,s,i,h,e,n){super(t,s,"rect",i,h),this.transform.width=e,this.transform.height=n}}class at extends lt{constructor(t,s,i,h,e){super(t,s,"circle",i,h),Y(this,"radius"),this.radius=e}}class ut extends lt{constructor(t,s,i,h){super(t,s,"point",i,h)}}class ct{constructor(){Y(this,"objectTable",{}),Y(this,"objectList",[]),Y(this,"sortedXCoordinates",[]),this.sortedXCoordinates=[]}addObject(t){this.objectTable[t.uuid]=t,this.objectList.push(t),this.sortedXCoordinates.push({collider:t,x:t.worldPosition[0],left:!0}),this.sortedXCoordinates.push({collider:t,x:t.worldPosition[0]+(t.transform.width??0),left:!1})}removeObject(t){delete this.objectTable[t],this.objectList=this.objectList.filter((s=>s.uuid!==t))}updateXCoordinates(){for(const t of this.sortedXCoordinates)t.left?"circle"===t.collider.type?t.x=t.collider.worldPosition[0]-t.collider.radius:("rect"===t.collider.type||"point"===t.collider.type)&&(t.x=t.collider.worldPosition[0]):"circle"===t.collider.type?t.x=t.collider.worldPosition[0]+t.collider.radius:"rect"===t.collider.type?t.x=t.collider.worldPosition[0]+t.collider.transform.width:"point"===t.collider.type&&(t.x=t.collider.worldPosition[0])}sortXCoordinates(){this.sortedXCoordinates.sort(((t,s)=>t.x-s.x))}detectCollisions(){var t,s;this.updateXCoordinates(),this.sortXCoordinates();let i=new Set;for(const h of this.sortedXCoordinates)if(h.left){for(const t of i)this.isIntersecting(h.collider,t)&&(this.onColliderCollide(h.collider,t),this.onColliderCollide(t,h.collider));i.add(h.collider)}else i.delete(h.collider);for(const h of this.sortedXCoordinates)if(h.left){for(const i of h.collider.Z)h.collider.H.has(i)||(null==(s=(t=h.collider.event.collider).onEndContact)||s.call(t,h.collider,i),h.collider.Z.delete(i));h.collider.H.clear()}}isIntersecting(t,s){const i=t,h=s;return"rect"===i.type&&"rect"===h.type?this.isRectIntersecting(i,h):"circle"===i.type&&"circle"===h.type?this.isCircleIntersecting(i,h):"rect"===i.type&&"circle"===h.type?this.isRectCircleIntersecting(i,h):"circle"===i.type&&"rect"===h.type?this.isRectCircleIntersecting(h,i):"rect"===i.type&&"point"===h.type?this.isRectPointIntersecting(i,h):"point"===i.type&&"rect"===h.type?this.isRectPointIntersecting(h,i):"point"===i.type&&"circle"===h.type?this.isCirclePointIntersecting(h,i):"circle"===i.type&&"point"===h.type?this.isCirclePointIntersecting(i,h):"point"===i.type&&"point"===h.type&&this.isPointPointIntersecting(i,h)}onColliderCollide(t,s){var i,h;t.event.collider.onCollide&&t.event.collider.onCollide(t,s),t.Z.has(s)||(null==(h=(i=t.event.collider).onBeginContact)||h.call(i,t,s),t.Z.add(s)),t.H.add(s)}isRectIntersecting(t,s){return t.uuid!==s.uuid&&t.worldPosition[1]<s.worldPosition[1]+s.transform.height&&t.worldPosition[1]+t.transform.height>s.worldPosition[1]}isRectCircleIntersecting(t,s){let i=s.worldPosition[0],h=s.worldPosition[1];s.worldPosition[0]<t.worldPosition[0]?i=t.worldPosition[0]:s.worldPosition[0]>t.worldPosition[0]+t.transform.width&&(i=t.worldPosition[0]+t.transform.width),s.worldPosition[1]<t.worldPosition[1]?h=t.worldPosition[1]:s.worldPosition[1]>t.worldPosition[1]+t.transform.height&&(h=t.worldPosition[1]+t.transform.height);let e=s.worldPosition[0]-i,n=s.worldPosition[1]-h;return Math.sqrt(e*e+n*n)<=(s.radius??0)}isRectPointIntersecting(t,s){return s.worldPosition[0]>=t.worldPosition[0]&&s.worldPosition[0]<=t.worldPosition[0]+t.transform.width&&s.worldPosition[1]>=t.worldPosition[1]&&s.worldPosition[1]<=t.worldPosition[1]+t.transform.height}isCirclePointIntersecting(t,s){let i=t.worldPosition[0]-s.worldPosition[0],h=t.worldPosition[1]-s.worldPosition[1];return Math.sqrt(i*i+h*h)<=(t.radius??0)}isCircleIntersecting(t,s){if(t.uuid===s.uuid)return!1;let i=t.worldPosition[0]-s.worldPosition[0],h=t.worldPosition[1]-s.worldPosition[1];return Math.sqrt(i*i+h*h)<=(t.radius??0)+(s.radius??0)}isPointPointIntersecting(t,s){return t.uuid!==s.uuid&&(t.worldPosition[0]===s.worldPosition[0]&&t.worldPosition[1]===s.worldPosition[1])}}class dt{constructor(){Y(this,"containerElement"),Y(this,"cursor"),Y(this,"camera"),Y(this,"inputEngine"),Y(this,"collisionEngine"),Y(this,"objectTable"),Y(this,"currentStage"),Y(this,"read1Queue"),Y(this,"write1Queue"),Y(this,"read2Queue"),Y(this,"write2Queue"),Y(this,"read3Queue"),Y(this,"write3Queue"),Y(this,"animationList",[]),Y(this,"animationFragment"),Y(this,"debugMarkerList",{}),Y(this,"data"),Y(this,"snapline"),Y(this,"gid"),this.containerElement=null,this.cursor={worldX:0,worldY:0,cameraX:0,cameraY:0,screenX:0,screenY:0},this.camera=null,this.collisionEngine=null,this.objectTable={},this.inputEngine=new nt(this),this.currentStage="IDLE",this.read1Queue={},this.write1Queue={},this.read2Queue={},this.write2Queue={},this.read3Queue={},this.write3Queue={},this.animationList=[],this.animationFragment=document.createElement("div"),document.body.appendChild(this.animationFragment),this.data={},this.snapline=null,this.gid=0}getGlobalId(){return this.gid++,this.gid.toString()}}L=new WeakMap,A=new WeakMap,I=new WeakSet,T=function(){this.K(),window.requestAnimationFrame(z(this,I,T).bind(this))},O=function(t,s){var i,h,e,n,r,l,o,a,u,c,d,f;let p=new Set;for(const g of Object.values(s))for(const s of g.values())if(s.callback){for(const t of s.callback)t();p.has(s.object)||(p.add(s.object),s.object instanceof it&&("READ_1"==t?null==(h=(i=s.object.callback).afterRead1)||h.call(i):"READ_2"==t?null==(n=(e=s.object.callback).afterRead2)||n.call(e):"READ_3"==t?null==(l=(r=s.object.callback).afterRead3)||l.call(r):"WRITE_1"==t?null==(a=(o=s.object.callback).afterWrite1)||a.call(o):"WRITE_2"==t?null==(c=(u=s.object.callback).afterWrite2)||c.call(u):"WRITE_3"==t&&(null==(f=(d=s.object.callback).afterWrite3)||f.call(d))))}};class ft extends it{constructor(t,s){super(t,s),Y(this,"endWorldX"),Y(this,"endWorldY"),Y(this,"start"),Y(this,"target"),this.endWorldX=0,this.endWorldY=0,this.start=s,this.target=null,this.transformMode="direct"}setLineStartAtConnector(){this.setLineStart(this.start.transform.x,this.start.transform.y)}setLineEndAtConnector(){this.target&&this.setLineEnd(this.target.transform.x,this.target.transform.y)}setLineStart(t,s){this.worldPosition=[t,s]}setLineEnd(t,s){this.endWorldX=t,this.endWorldY=s}setLinePosition(t,s,i,h){this.setLineStart(t,s),this.setLineEnd(i,h)}moveLineToConnectorTransform(){this.setLineStartAtConnector(),this.target&&this.setLineEndAtConnector()}}class pt extends it{constructor(t,s,i={}){super(t,s),Y(this,"config"),Y(this,"name"),Y(this,"prop"),Y(this,"outgoingLines"),Y(this,"incomingLines"),Y(this,"_state",0),Y(this,"_hitCircle"),Y(this,"_mouseHitBox"),Y(this,"_targetConnector",null),Y(this,"_mousedownX",0),Y(this,"_mousedownY",0),this.prop={},this.outgoingLines=[],this.incomingLines=[],this.config=i,this.name=i.name||this.gid||"",this.event.input.pointerDown=this.onCursorDown,this.J=new at(t,this,0,0,30),this.addCollider(this.J),this.V=new ut(t,this,0,0),this.addCollider(this.V),this.tt=null,this.st=0,this.it=0,this.transformMode="none"}onCursorDown(t){const s=this.incomingLines.filter((t=>!t._));0==t.event.button&&(this.inputEngine.resetDragMembers(),s.length>0?this.startPickUpLine(s[0],t):this.config.allowDragOut&&this.startDragOutLine(t))}deleteLine(t){if(0==this.outgoingLines.length)return null;const s=this.outgoingLines[t];return s.destroy(),this.outgoingLines.splice(t,1),s}deleteAllLines(){for(const t of this.outgoingLines)t.destroy()}updateAllLines(){var t;this.calculateTransformFromLocal();for(const s of[...this.outgoingLines,...this.incomingLines])null==(t=s.target)||t.calculateTransformFromLocal(),s.calculateLocalFromTransform(),s.moveLineToConnectorTransform(),s.requestTransform("WRITE_2")}assignToNode(t){this.parent=t,t.children.push(this);let s=this.parent;s.ht[this.name]=null,this.prop=s.ht,s.et[this.name]=this,this.outgoingLines=[],this.incomingLines=[],s.global&&null==this.global&&(this.global=s.global)}createLine(){let t;return t=this.config.lineClass?new this.config.lineClass(this.global,this):new ft(this.global,this),this.children.push(t),t}startDragOutLine(t){let s=this.createLine();s.setLineEnd(t.position.x,t.position.y),s.setLineStartAtConnector(),this.outgoingLines.unshift(s),this.parent.updateNodeLines(),this.parent.updateNodeLineList(),this.P=1,this.tt=null,this.event.input.drag=this.runDragOutLine,this.event.input.dragEnd=this.endDragOutLine,this.V.event.collider.onCollide=(t,s)=>{this.findClosestConnector()},this.V.event.collider.onEndContact=(t,s)=>{var i;(null==(i=this.tt)?void 0:i.gid)==s.parent.gid&&(this.tt=null)},this.runDragOutLine({position:t.position,start:{x:this.transform.x,y:this.transform.y},delta:{x:t.position.x-this.transform.x,y:t.position.y-this.transform.y}})}findClosestConnector(){let t=Array.from(this.V.Z).filter((t=>t.parent instanceof pt)).map((t=>t.parent)).sort(((t,s)=>Math.sqrt(Math.pow(t.transform.x-this.V.transform.x,2)+Math.pow(t.transform.y-this.V.transform.y,2))-Math.sqrt(Math.pow(s.transform.x-this.V.transform.x,2)+Math.pow(s.transform.y-this.V.transform.y,2))));t.length>0?this.tt=t[0]:this.tt=null}runDragOutLine(t){if(1!=this.P)return;if(0==this.outgoingLines.length)return;this.V.transform.x=t.position.x-this.transform.x,this.V.transform.y=t.position.y-this.transform.y;let s=this.outgoingLines[0];if(this.tt){const t=this.hoverWhileDragging(this.tt);if(t)return s.setLineEnd(t[0],t[1]),s.setLineStartAtConnector(),void s.requestTransform("WRITE_2")}s.setLineEnd(t.position.x,t.position.y),s.setLineStartAtConnector(),this.parent.updateNodeLines()}hoverWhileDragging(t){if(!(t instanceof pt))return;if(null==t)return;if(t.gid==this.gid)return;return[t.transform.x,t.transform.y]}endDragOutLine(t){if(this.inputEngine.resetDragMembers(),this.tt&&this.tt instanceof pt){const t=this.tt;if(null==t)return void this.nt();if(0==this.connectToConnector(t,this.outgoingLines[0]))return this.nt(),void this.deleteLine(0);t.prop[t.name]=this.prop[this.name],this.outgoingLines[0].setLineEnd(t.transform.x,t.transform.y)}else this.deleteLine(0);this.parent&&this.parent.updateNodeLines(),this.nt()}nt(){this.P=0,this.event.global.pointerMove=null,this.event.global.pointerUp=null,this.parent.updateNodeLineList(),this.tt=null,this.V.event.collider.onBeginContact=null,this.V.event.collider.onEndContact=null,this.V.transform.x=0,this.V.transform.y=0}startPickUpLine(t,s){t.start.disconnectFromConnector(this),this.disconnectFromConnector(t.start),t.start.deleteLine(t.start.outgoingLines.indexOf(t)),this.inputEngine.resetDragMembers(),this.inputEngine.addDragMember(t.start.inputEngine),t.start.tt=this,t.start.startDragOutLine(s),this.P=1}connectToConnector(t,s){const i=t.incomingLines.filter((t=>!t._));return!i.some((t=>t.start==this))&&(t.config.maxConnectors!==i.length&&(null==s&&(s=this.createLine(),this.outgoingLines.unshift(s)),this.calculateLocalFromTransform(),s.target=t,t.incomingLines.push(s),!0))}disconnectFromConnector(t){for(const s of this.outgoingLines)if(s.target==t){s._=!0;break}}}class gt extends it{constructor(t,s,i={}){super(t,s),q(this,P),Y(this,"_config"),Y(this,"_connectors"),Y(this,"_components"),Y(this,"_nodeWidth",0),Y(this,"_nodeHeight",0),Y(this,"_dragStartX",0),Y(this,"_dragStartY",0),Y(this,"_prop"),Y(this,"_propSetCallback"),Y(this,"_nodeStyle"),Y(this,"_lineListCallback"),Y(this,"_hitBox"),Y(this,"_selected"),Y(this,"_mouseDownX"),Y(this,"_mouseDownY"),Y(this,"_hasMoved"),this.rt=i,this.et={},this.lt={},this.ot=this.transform.x,this.ut=this.transform.y,this.ct=0,this.dt=0,this.ht={},this.ft={},this.transform.x=0,this.transform.y=0,this.gt=null,this.event.input.pointerDown=this.onCursorDown,this.event.input.dragStart=this.onDragStart,this.event.input.drag=this.onDrag,this.event.input.dragEnd=this.onDragEnd,this.event.input.pointerUp=this.onUp,this.bt=new ot(this.global,this,0,0,0,0),this.addCollider(this.bt),this.wt=!1,this._t=!1,this.event.dom.onResize=()=>{this.queueUpdate("READ_1",(()=>{this.readDom(!1,"READ_1");for(const t of Object.values(this.et))t.readDom(!1,"READ_1"),t.calculateLocalFromDom("READ_1"),t.calculateTransformFromLocal()}));for(const t of[...this.getAllOutgoingLines(),...this.getAllIncomingLines()])t.queueUpdate("WRITE_1",(()=>{t.moveLineToConnectorTransform(),t.setLineEndAtConnector(),t.writeDom(),t.writeTransform()}))},this.style={willChange:"transform",position:"absolute",transformOrigin:"top left"},this.event.dom.onAssignDom=()=>{this.bt.element=this.element}}setSelected(t){this.wt=t,this.dataAttribute={selected:t},t?(this.classList.push("selected"),this.global.data.select.push(this)):(this.classList=this.classList.filter((t=>"selected"!==t)),this.global.data.select=this.global.data.select.filter((t=>t.gid!==this.gid))),this.requestWrite()}vt(t){for(let s=0;s<t.length;s++)t[s]._&&(t.splice(s,1),s--)}updateNodeLines(){for(const t of Object.values(this.et))t.updateAllLines()}updateNodeLineList(){this.gt&&this.gt(this.getAllOutgoingLines())}setLineListCallback(t){this.gt=t}onCursorDown(t){var s;if(0==t.event.button&&0==(null==(s=this.global.data.select)?void 0:s.includes(this))){for(const t of this.global.data.select)t.setSelected(!1);this.setSelected(!0)}}onDragStart(t){var s;for(const i of this.global.data.select??[])z(s=i,P,X).call(s),i.ct=t.start.x,i.dt=t.start.y;this._t=!0}onDrag(t){if(null!=this.global&&!this.rt.lockPosition)for(const s of this.global.data.select??[])s.setDragPosition(t)}setDragPosition(t){const s=t.position.x-this.ct,i=t.position.y-this.dt;this.worldPosition=[this.ot+s,this.ut+i],this.updateNodeLines(),this.requestTransform("WRITE_2")}onDragEnd(t){for(const s of this.global.data.select??[])s.setUpPosition(t)}setUpPosition(t){const[s,i]=[t.end.x-this.ct,t.end.y-this.dt];this.worldPosition=[this.ot+s,this.ut+i],this.updateNodeLines()}onUp(t){if(0!=this._t);else{for(const t of this.global.data.select??[])t.setSelected(!1);this.setSelected(!0)}}getConnector(t){return t in this.et?this.et[t]:null}addConnectorObject(t){t.assignToNode(this)}addSetPropCallback(t,s){this.ft[s]=t}getAllOutgoingLines(){return Object.values(this.et).flatMap((t=>t.outgoingLines))}getAllIncomingLines(){return Object.values(this.et).flatMap((t=>t.incomingLines))}getProp(t){return this.ht[t]}setProp(t,s){if(t in this.ft&&this.ft[t](s),this.ht[t]=s,!(t in this.et))return;const i=this.et[t].outgoingLines.filter((t=>t.target&&!t._)).map((t=>t.target));if(i)for(const h of i){if(!h)continue;if(!h.parent)continue;h.parent.setProp(h.name,s)}}}P=new WeakSet,X=function(){this.ot=this.transform.x,this.ut=this.transform.y};t.Background=class extends it{constructor(t,s){super(t,s),Y(this,"_tileSize",40),this.event.global.pointerMove=this.moveBackground,this.dom.style={position:"absolute",top:"0",left:"0",backgroundSize:`${this.Dt}px ${this.Dt}px`},this.moveBackground()}moveBackground(t){var s,i,h,e;let n=null==(s=this.global.camera)?void 0:s.cameraPositionX,r=null==(i=this.global.camera)?void 0:i.cameraPositionY,l=5*(null==(h=this.global.camera)?void 0:h.cameraWidth),o=5*(null==(e=this.global.camera)?void 0:e.cameraHeight);this.worldPosition=[Math.floor(n/this.Dt)*this.Dt-l/2,Math.floor(r/this.Dt)*this.Dt-o/2],this.dom.style={width:`${l}px`,height:`${o}px`},this.requestPostWrite()}},t.BaseObject=tt,t.CameraControl=class extends it{constructor(t,s=!1,i=!1){super(t,null),Y(this,"_state","idle"),Y(this,"_mouseDownX"),Y(this,"_mouseDownY"),Y(this,"zoomLock"),Y(this,"panLock"),Y(this,"resizeObserver",null),this.zoomLock=s,this.panLock=i,this.ct=0,this.dt=0,this.P="idle",this.event.global.pointerDown=this.onCursorDown,this.event.global.pointerMove=this.onCursorMove,this.event.global.pointerUp=this.onCursorUp,this.event.global.mouseWheel=this.onZoom,this.transformMode="direct",this.style={position:"absolute",left:"0px",top:"0px",width:"0px",height:"0px"},this.requestTransform("WRITE_2"),this.resizeObserver=null,this.global.snapline.event.containerElementAssigned=()=>{this.resizeObserver=new ResizeObserver((()=>{var t,s,i,h;null==(t=this.global.camera)||t.updateCameraProperty(),null==(s=this.global.camera)||s.centerCamera(0,0),null==(i=this.global.camera)||i.updateCamera(),this.style.transform=null==(h=this.global.camera)?void 0:h.canvasStyle,this.requestTransform("WRITE_2")})),this.resizeObserver.observe(this.global.containerElement),this.resizeObserver.observe(window.document.body)}}setCameraPosition(t,s){var i,h;null==(i=this.global.camera)||i.setCameraPosition(t,s),this.style.transform=null==(h=this.global.camera)?void 0:h.canvasStyle,this.requestTransform("WRITE_2")}onCursorDown(t){var s;1==t.event.button&&(this.panLock||(this.P="panning",this.ct=t.position.screenX,this.dt=t.position.screenY,null==(s=this.global.camera)||s.handlePanStart(),t.event.preventDefault()))}onCursorMove(t){var s,i;if("panning"!=this.P)return;const h=t.position.screenX-this.ct,e=t.position.screenY-this.dt;null==(s=this.global.camera)||s.handlePanDrag(h,e),this.style.transform=null==(i=this.global.camera)?void 0:i.canvasStyle,this.requestTransform("WRITE_2")}onCursorUp(t){var s,i;"panning"==this.P&&(this.P="idle",null==(s=this.global.camera)||s.handlePanEnd(),this.style.transform=null==(i=this.global.camera)?void 0:i.canvasStyle,this.requestTransform("WRITE_2"))}onZoom(t){var s,i;if(this.zoomLock)return;let h=this.global.camera;t.position.screenX<h.containerOffsetX||t.position.screenX>h.containerOffsetX+h.cameraWidth||t.position.screenY<h.containerOffsetY||t.position.screenY>h.containerOffsetY+h.cameraHeight||(null==(s=this.global.camera)||s.handleScroll(t.delta/2e3,t.position.cameraX,t.position.cameraY),this.style.transform=null==(i=this.global.camera)?void 0:i.canvasStyle,this.requestTransform("WRITE_2"),t.event.preventDefault())}},t.ConnectorComponent=pt,t.ElementObject=it,t.GlobalManager=dt,t.LineComponent=ft,t.NodeComponent=gt,t.RectSelectComponent=class extends it{constructor(t,s){super(t,s),Y(this,"_state"),Y(this,"_mouseDownX"),Y(this,"_mouseDownY"),Y(this,"_selectHitBox"),this.P="none",this.ct=0,this.dt=0,this.event.global.pointerDown=this.onGlobalCursorDown,this.event.global.pointerMove=this.onGlobalCursorMove,this.event.global.pointerUp=this.onGlobalCursorUp,this.Et=new ot(t,this,0,0,0,0),this.Et.transform.x=0,this.Et.transform.y=0,this.Et.event.collider.onCollide=this.onCollideNode,this.addCollider(this.Et),this.global.data.select=[],this.style={width:"0px",height:"0px",transformOrigin:"top left",position:"absolute",left:"0px",top:"0px",pointerEvents:"none"},this.requestWrite()}onGlobalCursorDown(t){if(!(0!==t.event.button||t.event.target&&"sl-background"!==t.event.target.id)){for(let t of this.global.data.select)t.setSelected(!1);this.global.data.select=[],this.worldPosition=[t.position.x,t.position.y],this.Et.recalculate(),this.P="dragging",this.style={display:"block",width:"0px",height:"0px"},this.ct=t.position.x,this.dt=t.position.y,this.Et.event.collider.onBeginContact=(t,s)=>{if(s.parent instanceof gt){s.parent.setSelected(!0)}},this.Et.event.collider.onEndContact=(t,s)=>{if(s.parent instanceof gt){s.parent.setSelected(!1)}}}}onGlobalCursorMove(t){if("dragging"===this.P){let[s,i]=[Math.min(this.ct,t.position.x),Math.min(this.dt,t.position.y)],[h,e]=[Math.abs(t.position.x-this.ct),Math.abs(t.position.y-this.dt)];this.style={width:`${h}px`,height:`${e}px`},this.worldPosition=[s,i],this.Et.transform.x=this.transform.x-s,this.Et.transform.y=this.transform.y-i,this.Et.transform.width=h,this.Et.transform.height=e,this.requestTransform()}}onGlobalCursorUp(t){this.style={display:"none"},this.P="none",this.Et.event.collider.onBeginContact=null,this.Et.event.collider.onEndContact=null,this.requestTransform()}onCollideNode(t,s){}},t.SnapLine=class{constructor(t={}){q(this,I),Y(this,"snaplineConfig"),q(this,L,{}),Y(this,"global"),Y(this,"_collisionEngine",null),Y(this,"_event"),Y(this,"event"),Y(this,"debug",!1),Y(this,"debugWindow",null),Y(this,"debugCtx",null),q(this,A,null),this.global=new dt,this.global.read1Queue={},this.global.write1Queue={},this.global.read2Queue={},this.global.write2Queue={},this.global.read3Queue={},this.global.write3Queue={},this.global.animationList=[],this.global.snapline=this;this.snaplineConfig={cameraConfig:{enableZoom:!0,enablePan:!0,panBounds:{top:null,left:null,right:null,bottom:null}},...t},U(this,L,{position:"relative",overflow:"hidden"}),this.global.collisionEngine=new ct,this.q={containerElementAssigned:null},this.event=H(this,this.q),this.debug=!1,U(this,A,new ResizeObserver((()=>{if(this.debug){let t=this.global.containerElement.getBoundingClientRect();this.debugWindow.width=t.width,this.debugWindow.height=t.height}})))}enableDebug(){if(null==this.global.containerElement)return;this.debug=!0,this.debugWindow=document.createElement("canvas"),this.debugWindow.style.position="absolute",this.debugWindow.style.top="0",this.debugWindow.style.left="0";let t=this.global.containerElement.getBoundingClientRect();this.debugWindow.width=t.width,this.debugWindow.height=t.height,this.debugWindow.style.zIndex="1000",this.debugWindow.style.pointerEvents="none",this.global.containerElement.appendChild(this.debugWindow),this.debugCtx=this.debugWindow.getContext("2d")}disableDebug(){this.debug=!1,this.debugWindow&&(this.debugWindow.remove(),this.debugWindow=null,this.debugCtx=null)}assignDom(t){var s,i,h;this.global.containerElement=t,this.global.camera=new G(t),null==(i=(s=this.event).containerElementAssigned)||i.call(s,t),null==(h=F(this,A))||h.observe(t),window.requestAnimationFrame(z(this,I,T).bind(this))}debugObjectBoundingBox(t){var s,i,h;if(null==this.debugCtx)return;this.debugCtx.beginPath(),this.debugCtx.fillStyle="rgba(0, 0, 0, 0.5)";const[e,n]=(null==(s=this.global.camera)?void 0:s.getCameraFromWorld(...t.worldPosition))??[0,0];if(this.debugCtx.rect(e,n,20,20),this.debugCtx.fill(),this.debugCtx.fillStyle="white",this.debugCtx.fillText(t.gid,e,n+10),t.hasOwnProperty("_dom")){let s=t;const h=["#FF0000A0","#00FF00A0","#0000FFA0"],r=["READ_1","READ_2","READ_3"];for(let t=0;t<3;t++){const e=s.getDomProperty(r[t]);this.debugCtx.stroke(),this.debugCtx.beginPath(),this.debugCtx.strokeStyle=h[t],this.debugCtx.lineWidth=1;const[n,l]=(null==(i=this.global.camera)?void 0:i.getCameraFromWorld(e.x,e.y))??[0,0];this.debugCtx.rect(n,l,e.width,e.height),this.debugCtx.stroke()}this.debugCtx.beginPath(),this.debugCtx.strokeStyle="black",this.debugCtx.lineWidth=1,this.debugCtx.rect(e,n,s.t.property.width,s.t.property.height)}const r="rgba(0, 0, 255, 0.5)";for(let l of t.o){this.debugCtx.beginPath(),this.debugCtx.strokeStyle=r,this.debugCtx.lineWidth=1;const[s,i]=(null==(h=this.global.camera)?void 0:h.getCameraFromWorld(t.transform.x+l.transform.x,t.transform.y+l.transform.y))??[0,0];"circle"==l.type?(this.debugCtx.arc(s,i,l.radius,0,2*Math.PI),this.debugCtx.stroke()):"rect"==l.type?(this.debugCtx.rect(s,i,l.transform.width,l.transform.height),this.debugCtx.stroke()):"point"==l.type&&(this.debugCtx.arc(s,i,2,0,2*Math.PI),this.debugCtx.fillStyle=r,this.debugCtx.fill())}}renderDebugGrid(){if(null==this.debugCtx)return;const t=100,s=this.global.camera;if(!s)return;const[i,h]=s.getWorldFromCamera(0,0),[e,n]=s.getWorldFromCamera(this.debugWindow.width,this.debugWindow.height),r=Math.floor(i/t)*t,l=Math.ceil(e/t)*t,o=Math.floor(h/t)*t,a=Math.ceil(n/t)*t;this.debugCtx.beginPath(),this.debugCtx.strokeStyle="rgba(200, 200, 200, 0.3)",this.debugCtx.lineWidth=1;for(let f=r;f<=l;f+=t){const[t,i]=s.getCameraFromWorld(f,h),[e,r]=s.getCameraFromWorld(f,n);this.debugCtx.moveTo(t,i),this.debugCtx.lineTo(e,r)}for(let f=o;f<=a;f+=t){const[t,h]=s.getCameraFromWorld(i,f),[n,r]=s.getCameraFromWorld(e,f);this.debugCtx.moveTo(t,h),this.debugCtx.lineTo(n,r)}this.debugCtx.stroke(),this.debugCtx.beginPath(),this.debugCtx.strokeStyle="rgba(0, 0, 0, 0.8)",this.debugCtx.lineWidth=2;const u=r<=0&&l>=0;if(o<=0&&a>=0){const[t,i]=s.getCameraFromWorld(r,0),[h,e]=s.getCameraFromWorld(l,0);this.debugCtx.moveTo(t,i),this.debugCtx.lineTo(h,e)}if(u){const[t,i]=s.getCameraFromWorld(0,o),[h,e]=s.getCameraFromWorld(0,a);this.debugCtx.moveTo(t,i),this.debugCtx.lineTo(h,e)}this.debugCtx.stroke(),this.debugCtx.fillStyle="rgba(0, 0, 0, 0.8)",this.debugCtx.font="12px Arial",this.debugCtx.textAlign="center";for(let f=r;f<=l;f+=t){if(0===f)continue;const[t,i]=s.getCameraFromWorld(f,0);i>=0&&i<=this.debugWindow.height&&this.debugCtx.fillText(f.toString(),t,i+20)}for(let f=o;f<=a;f+=t){if(0===f)continue;const[t,i]=s.getCameraFromWorld(0,f);t>=0&&t<=this.debugWindow.width&&this.debugCtx.fillText(f.toString(),t-20,i+4)}const[c,d]=s.getCameraFromWorld(0,0);c>=0&&c<=this.debugWindow.width&&d>=0&&d<=this.debugWindow.height&&this.debugCtx.fillText("(0,0)",c+20,d-10)}renderDebugFrame(t){var s,i;if(null!=this.debugWindow){null==(s=this.debugCtx)||s.clearRect(0,0,this.debugWindow.width,this.debugWindow.height),this.renderDebugGrid();for(const t of Object.values(this.global.objectTable))this.debugObjectBoundingBox(t);if(null!=this.debugCtx){for(const t of Object.values(this.global.debugMarkerList)){const[s,h]=(null==(i=this.global.camera)?void 0:i.getCameraFromWorld(t.x,t.y))??[0,0];"point"==t.type?(this.debugCtx.beginPath(),this.debugCtx.fillStyle=t.color,this.debugCtx.arc(s,h,5,0,2*Math.PI),this.debugCtx.fill()):"rect"==t.type?(this.debugCtx.beginPath(),this.debugCtx.fillStyle=t.color,this.debugCtx.rect(s,h,t.width,t.height),this.debugCtx.fill()):"circle"==t.type?(this.debugCtx.beginPath(),this.debugCtx.fillStyle=t.color,this.debugCtx.arc(s,h,t.radius,0,2*Math.PI),this.debugCtx.fill()):"text"==t.type&&(this.debugCtx.fillStyle=t.color,this.debugCtx.fillText(t.text,s,h))}for(const t in this.global.debugMarkerList)this.global.debugMarkerList[t].persistent||delete this.global.debugMarkerList[t]}}}K(){var t;let s={timestamp:Date.now()};this.global.currentStage="READ_1",z(this,I,O).call(this,"READ_1",this.global.read1Queue),this.global.read1Queue={},this.global.currentStage="WRITE_1",z(this,I,O).call(this,"WRITE_1",this.global.write1Queue),this.global.write1Queue={},this.global.currentStage="READ_2",z(this,I,O).call(this,"READ_2",this.global.read2Queue),this.global.read2Queue={},this.global.currentStage="WRITE_2",z(this,I,O).call(this,"WRITE_2",this.global.write2Queue),this.global.write2Queue={};let i=[];for(const h of this.global.animationList)0==h.calculateFrame(s.timestamp)&&0==h.requestDelete&&i.push(h);this.global.animationList=i,this.global.currentStage="READ_3",z(this,I,O).call(this,"READ_3",this.global.read3Queue),this.global.read3Queue={},this.global.currentStage="WRITE_3",z(this,I,O).call(this,"WRITE_3",this.global.write3Queue),this.global.write3Queue={},this.global.currentStage="IDLE",null==(t=this.global.collisionEngine)||t.detectCollisions(),this.renderDebugFrame(s)}},Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}));
