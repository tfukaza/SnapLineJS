var SnapLine=function(){"use strict";function n(t,e,s){return e<=t&&t<=s||s<=t&&t<=e}function i(t,e,s){return s.zoom+`,0,0,0,0,${s.zoom},0,0,0,0,1,0,${-t*s.zoom+s.cameraWidth/2},${-e*s.zoom+s.cameraHeight/2},0,1`}function c(t,e){if(""!==e.name){const s=document.createElement("span");s.classList.add("sl-label"),s.innerText=e.name,t.appendChild(s)}}class t{g;gid;position_x;position_y;constructor(t){(this.g=t).gid++,this.gid=t.gid.toString(),this.position_x=0,this.position_y=0}domMouseDown(t){this.g.isMouseDown=!0,(this.g.targetNode=this).g.mousedown_x=t.clientX,this.g.mousedown_y=t.clientY,this.g.dx=0,this.g.dy=0,this.g.dx_offset=0,this.g.dy_offset=0,this.onFocus(),this.customMouseDown(t),t.stopPropagation()}customMouseDown(t){console.debug(t)}domMouseUp(){}onFocus(){}offFocus(){}onDrag(){}onPan(){}}class e extends t{parent;config;dom;constructor(t,e,s){super(s),this.config=t,this.parent=e,this.dom=null}}class s extends e{connector_x;connector_y;c_total_offset_x;c_total_offset_y;name;parentContent;connector;constructor(t,e,s,n){super(t,e,s),this.connector_x=0,this.connector_y=0,this.c_total_offset_x=0,this.c_total_offset_y=0,this.dom=null,this.parentContent=n,this.connector=null,t.name?this.name=t.name:(s.gid++,this.name=s.gid.toString()),(this.parent.elements[this.name]=this).g.globalNodes[this.gid]=this}pxToInt(t){return parseInt(t.substring(0,t.length-2))}updateDOMproperties(){var t=this.parent.nodeContainerOffsetLeft,e=this.parent.nodeContainerOffsetTop,s=(this.pxToInt(window.getComputedStyle(this.parentContent).marginLeft),this.pxToInt(window.getComputedStyle(this.parentContent).paddingLeft),this.pxToInt(window.getComputedStyle(this.parentContent).borderLeftWidth),this.parentContent.offsetLeft,this.parentContent.offsetTop),n=this.pxToInt(window.getComputedStyle(this.connector).marginLeft)+this.pxToInt(window.getComputedStyle(this.connector).paddingLeft)+this.pxToInt(window.getComputedStyle(this.connector).borderLeftWidth)+this.connector.offsetLeft,o=this.pxToInt(window.getComputedStyle(this.connector).marginTop)+this.pxToInt(window.getComputedStyle(this.connector).paddingTop)+this.pxToInt(window.getComputedStyle(this.connector).borderTopWidth)+this.connector.offsetTop,i=(console.debug(`connector_offset_x: ${n} connector_offset_y: `+o),this.connector.getBoundingClientRect().width),a=this.connector.getBoundingClientRect().height;this.c_total_offset_x=t+0+n+i/2,this.c_total_offset_y=e+s+o+a/2}setLineXY(t,e,s){t.setAttribute("x1","0"),t.setAttribute("y1","0"),t.setAttribute("x2",""+e),t.setAttribute("y2",""+s),t.setAttribute("stroke-width",""+4*this.g.zoom)}}class o extends s{inputDOM;inputValue;peerOutput;constructor(t,e,s,n){super(t,e,s,n),this.inputDOM=null,this.peerOutput=null;const o=document.createElement("div"),i=(o.classList.add("sl-input"),document.createElement("span"));switch(i.classList.add("sl-input-connector"),i.id="input-"+this.gid,i.onmousedown=this.domMouseDown.bind(this),o.appendChild(i),this.inputValue=()=>{},t.type){case"input-text":{c(o,t);const a=document.createElement("input");a.classList.add("sl-input-text"),a.type="text",o.appendChild(a),(this.inputDOM=a).onkeyup=()=>{this.parent?.findLeaf()},this.inputValue=()=>this.inputDOM.value}break;case"input-bool":{c(o,t);const r=document.createElement("input");r.classList.add("sl-input-bool"),r.type="checkbox",o.appendChild(r),(this.inputDOM=r).onchange=()=>{this.parent?.findLeaf()},this.inputValue=()=>this.inputDOM.checked}}this.connector=i,this.dom=o}domMouseDown(t){this.peerOutput&&(super.domMouseDown(t),this.g.targetNode=this.peerOutput,this.g.dx_offset=(this.connector_x-this.peerOutput.connector_x)*this.g.zoom,this.g.dy_offset=(this.connector_y-this.peerOutput.connector_y)*this.g.zoom,this.g.dx=this.g.dx_offset,this.g.dy=this.g.dy_offset,this.peerOutput.customMouseDown(t),this.peerOutput.disconnectFromInput(this),t.stopPropagation())}updateConnectorPosition(){this.connector_x=this.parent.position_x+this.c_total_offset_x,this.connector_y=this.parent.position_y+this.c_total_offset_y}disconnectFromOutput(){this.peerOutput=null,this.dom?.classList.remove("connected")}connectToOutput(t){this.peerOutput=t,this.dom?.classList.add("connected")}nodeDrag(){this.updateConnectorPosition(),this.peerOutput&&this.peerOutput.nodeDrag()}getValue(){return this.peerOutput?this.peerOutput.getValue():this.inputDOM?this.inputValue():null}}class a extends s{val;svgTmp;svgs;constructor(t,e,s,n){super(t,e,s,n),this.val=null,this.svgTmp={svg:null,line:null},this.svgs=[];const o=document.createElement("div"),i=(o.classList.add("sl-output"),c(o,t),document.createElement("span"));i.classList.add("sl-output-connector"),i.id="output-"+this.gid,i.onmousedown=this.domMouseDown.bind(this),o.appendChild(i),this.connector=i,this.dom=o}connectToInput(t){var e,s,n;console.debug("Connecting to input: ",t),this===t.peerOutput?console.debug("Already connected"):(t.peerOutput&&(console.debug("Disconnecting from: ",t.peerOutput),t.peerOutput.disconnectFromInput(t),t.disconnectFromOutput()),console.debug("Now connecting to: ",t),t.connectToOutput(this),n={svg:e=(s=this.createNewSVG())[0],line:s=s[1],to:t,from:this,connector_x:this.connector_x,connector_y:this.connector_y,x2:0,y2:0,connector:this},this.svgs.push(n),this.g.globalLines.push(n),this.g.canvas.appendChild(e),this.setLineXY(s,t.connector_x-this.connector_x,t.connector_y-this.connector_y),this.parent.outputCount++,t.parent.inputCount++)}disconnectFromInput(t){console.debug("Disconnecting from input: ",t);for(const e of this.svgs)if(e.to==t){this.g.canvas.removeChild(e.svg),this.svgs=this.svgs.filter(t=>t!=e),this.g.globalLines=this.g.globalLines.filter(t=>t!=e),console.debug("Deleted line: ",e);break}t.disconnectFromOutput(),this.parent.outputCount--,t.parent.inputCount--}updateConnectorPosition(){this.connector_x=this.parent.position_x+this.c_total_offset_x,this.connector_y=this.parent.position_y+this.c_total_offset_y}getValue(){return this.parent.exec(),this.val}setValue(t){this.val=t}moveToParent(){if(this.updateConnectorPosition(),this.svgTmp.line&&(this.svgTmp.svg.style.transform=`translate3d(${this.connector_x}px, ${this.connector_y}px, 0)`),!(this.svgs.length<1))for(const t of this.svgs)t.svg.style.transform=`translate3d(${this.connector_x}px, ${this.connector_y}px, 0)`,t.connector_x=this.connector_x,t.connector_y=this.connector_y,t.x2=t.to.connector_x-this.connector_x,t.y2=t.to.connector_y-this.connector_y,this.setLineXY(t.line,t.x2,t.y2)}createNewSVG(){const t=document.createElementNS("http://www.w3.org/2000/svg","svg"),e=(t.classList.add("sl-connector-svg"),t.style.pointerEvents="none",t.style.position="absolute",t.style.overflow="visible",t.setAttribute("width","4"),t.setAttribute("height","4"),t.style.willChange="transform",document.createElementNS("http://www.w3.org/2000/svg","line"));return e.classList.add("sl-connector-line"),e.setAttribute("stroke-width",""+4*this.g.zoom),t.appendChild(e),this.updateConnectorPosition(),t.style.transform=`translate3d(${this.connector_x}px, ${this.connector_y}px, 0)`,this.g.canvas.appendChild(t),[t,e]}customMouseDown(t){var e=this.createNewSVG();this.svgTmp.svg=e[0],this.svgTmp.line=e[1],this.moveToParent(),this.setLineXY(this.svgTmp.line,this.g.dx,this.g.dy)}onDrag(){let t=9999,e=0,s=0;const n=this.g.hoverDOM;if(n&&n.id&&n.id.startsWith("input-")){var o=n.id.split("-")[1];const i=this.g.globalNodes[o];i.updateConnectorPosition(),e=i.connector_x,s=i.connector_y,t=Math.sqrt(Math.pow(this.connector_x+this.g.dx/this.g.zoom-e,2)+Math.pow(this.connector_y+this.g.dy/this.g.zoom-s,2))}t<40?this.setLineXY(this.svgTmp.line,e-this.connector_x,s-this.connector_y):this.setLineXY(this.svgTmp.line,this.g.dx/this.g.zoom,this.g.dy/this.g.zoom)}nodeDrag(){this.moveToParent()}domMouseUp(){const t=this.g.hoverDOM;if(t&&t.id&&t.id.startsWith("input-")){console.debug("Connecting to input: ",t.id);const e=this.g.globalNodes[t.id.split("-")[1]];this.connectToInput(e),e.parent.findLeaf()}this.g.canvas.removeChild(this.svgTmp.svg),this.svgTmp={svg:null,line:null}}}class r extends e{parentContent;getUIvalue;setUIvalue;name;constructor(t,e,s,n){super(t,e,s),this.parentContent=n,this.name=t.name,this.getUIvalue=()=>null,this.setUIvalue=t=>{console.debug(t)};const o=document.createElement("div");switch(o.classList.add("sl-ui"),t.type){case"ui-paragraph":const i=document.createElement("p");i.style.pointerEvents="none",i.innerText=t.text,o.appendChild(i);break;case"ui-display":const a=document.createElement("p");a.style.pointerEvents="none",a.innerText="Output",o.appendChild(a),this.setSetFunction(t=>{a.innerText=t});break;case"ui-dropdown":const r=document.createElement("select");r.classList.add("sl-ui-dropdown");for(const c of t.values){const h=document.createElement("option");h.innerText=c.label,h.value=c.value,r.appendChild(h)}o.appendChild(r),this.setGetFunction(()=>r.value),this.setExecTrigger(r,"change")}this.dom=o,this.name&&(this.parent.elements[this.name]=this)}setExecTrigger(t,e){t.addEventListener(e,()=>{this.parent?.findLeaf()}),console.debug(t,e)}setGetFunction(t){this.getUIvalue=t}setSetFunction(t){this.setUIvalue=t}getValue(){return this.getUIvalue()}setValue(t){return this.setUIvalue(t)}}class h extends e{parentContent;getUIvalue;setUIvalue;constructor(t,e,s,n){super(t,e,s),this.parentContent=n,this.getUIvalue=()=>null,this.setUIvalue=t=>{console.debug(t)};const o=document.createElement("template");o.innerHTML=t.html.trim(),this.dom=o.content.firstChild}setExecTrigger(t,e){console.debug(t,e)}setGetFunction(t){this.getUIvalue=t}setSetFunction(t){this.setUIvalue=t}getValue(){return this.getUIvalue()}setValue(t){return this.setUIvalue(t)}}class u extends t{config;inputs;outputs;inputCount;outputCount;elements;dom;hasIandO;nodeWidth;nodeHeight;nodeContainerWidth;nodeContainerHeight;nodeContainerOffsetLeft;nodeContainerOffsetTop;functions;pan_start_x;pan_start_y;overlapping;constructor(t,e,s=0,n=0){super(e),this.config=t,this.position_x=s,this.position_y=n,this.inputs=[],this.outputs=[],this.inputCount=0,this.outputCount=0,this.elements={},this.pan_start_x=0,this.pan_start_y=0,this.overlapping=null;const o=document.createElement("div"),i=(o.classList.add("sl-node"),o.style.willChange="transform",o.style.position="absolute",o.style.transformOrigin="top left",o.style.position="absolute",document.createElement("div"));i.classList.add("sl-node-container"),i.style.position="relative";for(const u of t.elements){const d=document.createElement("div");if(d.style.position="relative",d.style.display="flex",d.style.flexDirection="row",d.classList.add("sl-node-content"),i.appendChild(d),u instanceof Array)for(const p of u){var a=this._initParseComponent(p,d);a&&d.appendChild(a.dom)}else{var r=this._initParseComponent(u,d);r&&d.appendChild(r.dom)}i.appendChild(d)}if(o.appendChild(i),o.id=this.gid,o.onmousedown=this.domMouseDown.bind(this),this.dom=o,0<this.inputs.length&&0<this.outputs.length?this.hasIandO=!0:this.hasIandO=!1,this.g.canvas.appendChild(o),this.nodeWidth=o.offsetWidth,this.nodeHeight=o.offsetHeight,this.nodeContainerWidth=i.offsetWidth,this.nodeContainerHeight=i.offsetHeight,this.nodeContainerOffsetLeft=i.offsetLeft,this.nodeContainerOffsetTop=i.offsetTop,this.updateDOMproperties(),this.g.nodeArray.push(this),new ResizeObserver(()=>{this.updateDOMproperties()}).observe(this.dom),this.functions=[],t.functions){this.functions=t.functions;for(var[c,h]of Object.entries(this.functions))void 0!==h.functionInit&&h.functionInit(this)}}_initParseComponent(t,e){let s=null;switch(t.type){case"input-text":case"input-bool":((s=new o(t,this,this.g,e)).parent=this).g.globalNodes[s.gid]=s,this.inputs.push(s);break;case"output-text":((s=new a(t,this,this.g,e)).parent=this).g.globalNodes[s.gid]=s,this.outputs.push(s);break;case"ui-display":case"ui-dropdown":case"ui-paragraph":((s=new r(t,this,this.g,e)).parent=this).g.globalNodes[s.gid]=s;break;case"custom":((s=new h(t,this,this.g,e)).parent=this).g.globalNodes[s.gid]=s;break;default:console.warn("Unknown type "+t.type)}return s}customMouseDown(t){console.debug(t),this.pan_start_x=this.position_x,this.pan_start_y=this.position_y}domMouseUp(){if(this.position_x=this.pan_start_x+this.g.dx/this.g.zoom,this.position_y=this.pan_start_y+this.g.dy/this.g.zoom,null!=this.overlapping){const s=this.overlapping.from;var t=this.overlapping.to,e=this.inputs[0];const n=this.outputs[0];s.disconnectFromInput(t),s.connectToInput(e),n.connectToInput(t)}}onPan(){this.dom.style.transform=`translate3d(${this.position_x}px, ${this.position_y}px, 0)`;for(const t of this.inputs)t.onPan();for(const e of this.outputs)e.onPan()}onDrag(){this.position_x=this.pan_start_x+this.g.dx/this.g.zoom,this.position_y=this.pan_start_y+this.g.dy/this.g.zoom,this.dom.style.transform=`translate3d(${this.position_x}px, ${this.position_y}px, 0)`;for(const t of this.inputs)t.nodeDrag();for(const e of this.outputs)e.nodeDrag();if(this.overlapping=null,this.hasIandO&&!(0<this.outputCount||0<this.inputCount)){let t=9999;for(const s of this.g.globalLines)s.line.classList.remove("overlapping"),n(this.position_x+this.nodeWidth/2,s.connector_x,s.connector_x+s.x2)&&n(this.position_y+this.nodeHeight/2,s.connector_y,s.connector_y+s.y2)&&(s.y2+s.connector_x)/2<t&&(this.overlapping=s,t=(s.y2+this.position_y)/2);this.overlapping&&this.overlapping.line.classList.add("overlapping")}}onFocus(){for(const t of this.g.nodeArray)t.dom.classList.remove("focused"),t.dom.style.zIndex="10";this.dom.classList.add("focused"),this.dom.style.zIndex="20"}offFocus(){this.dom.classList.remove("focused"),this.dom.style.zIndex="10"}updateDOMproperties(){this.nodeHeight=this.dom.offsetHeight,this.nodeWidth=this.dom.offsetWidth;for(const t of this.inputs)t.updateDOMproperties();for(const e of this.outputs)e.updateDOMproperties()}findLeaf(){let t=0;for(var[e,s]of Object.entries(this.functions))for(const o of s.outputs){var n=this.elements[o];if(null==n)return void console.warn(`Output '${o}' was not found in elements. Double check '${o}' is defined.`);if(n.svgs&&!(n.svgs.length<1)){t++;for(const i of n.svgs)i.to.parent?.findLeaf()}}0===t&&this.exec()}exec(){if(this.functions)for(var[t,e]of Object.entries(this.functions)){const n=[this];for(const o of e.inputs)if(o in this.elements){const i=this.elements[o];n.push(i.getValue())}var s=e.functionUpdate(...n);for(const a of e.outputs){const r=this.elements[a];if(null==r)return void console.warn(`Output '${a}' was not found in elements. Double check '${a}' is defined.`);r.setValue(s)}}}}return class{g;constructor(t){this.g={canvas:null,canvasContainer:null,isMouseDown:!1,mousedown_x:0,mousedown_y:0,mouse_x:0,mouse_y:0,camera_pan_start_x:0,camera_pan_start_y:0,dx:0,dy:0,dx_offset:0,dy_offset:0,camera_x:0,camera_y:0,zoom:1,cameraWidth:0,cameraHeight:0,targetNode:null,hoverDOM:null,gid:0,nodeArray:[],globalLines:[],globalNodes:{}};const o=this.g;if(o.canvasContainer=document.getElementById(t),o.canvasContainer){o.cameraWidth=o.canvasContainer.clientWidth,o.cameraHeight=o.canvasContainer.clientHeight,console.debug(`Canvas size: ${o.cameraWidth}x`+o.cameraHeight);const e=document.createElement("div");e.style.position="absolute",e.style.top="0px",e.style.left="0px",e.className="canvas",o.canvasContainer.appendChild(e),o.canvas=e,o.canvas.style.transform=`translate(${o.cameraWidth/2}px, ${o.cameraHeight/2}px)`,o.canvasContainer.addEventListener("mousedown",function(t){o.isMouseDown=!0,o.mousedown_x=t.clientX,o.mousedown_y=t.clientY,o.camera_pan_start_x=o.camera_x,o.camera_pan_start_y=o.camera_y;for(const e of o.nodeArray)e.offFocus()}),o.canvasContainer.addEventListener("mousemove",function(t){o.hoverDOM=t.target,o.mouse_x=t.clientX-o.canvasContainer.offsetLeft,o.mouse_y=t.clientY-o.canvasContainer.offsetTop,o.isMouseDown&&(o.dx=t.clientX-o.mousedown_x+o.dx_offset,o.dy=t.clientY-o.mousedown_y+o.dy_offset,null==o.targetNode&&(o.camera_x=o.camera_pan_start_x-o.dx/o.zoom,o.camera_y=o.camera_pan_start_y-o.dy/o.zoom,o.canvas.style.transform=`matrix3d(${i(o.camera_x,o.camera_y,o)})`,o.canvas.style.cursor="grabbing"))}),o.canvasContainer.addEventListener("wheel",function(t){var e,s,n=+o.zoom*(-t.deltaY/600);t.preventDefault(),o.zoom+n<.2?o.zoom=.2:3<o.zoom+n?o.zoom=3:(e=(o.mouse_x-o.cameraWidth/2)*n,s=(o.mouse_y-o.cameraHeight/2)*n,o.zoom+=n,o.camera_x+=e/o.zoom/o.zoom,o.camera_y+=s/o.zoom/o.zoom,o.canvas.style.transform=`matrix3d(${i(o.camera_x,o.camera_y,o)})`,t.preventDefault())}),o.canvasContainer.addEventListener("mouseup",function(t){o.isMouseDown=!1,o.canvas.style.cursor="default",null!=o.targetNode&&o.targetNode.domMouseUp(),o.targetNode=null,o.dx=0,o.dy=0,o.dx_offset=0,o.dy_offset=0}),console.info("Initialized SnapLine..."),window.requestAnimationFrame(this.step.bind(this))}else console.error("Canvas not found")}step(){this.g.targetNode&&this.g.targetNode.onDrag(),window.requestAnimationFrame(this.step.bind(this))}addNode(t,e,s){t=new u(t,this.g,e,s);return this.g.globalNodes[t.gid]=t}deleteNode(t){console.debug(t)}connectNodes(t,e,s,n){console.debug(t,e,s,n)}}}();
