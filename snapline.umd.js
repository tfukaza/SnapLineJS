!function(t,s){"object"==typeof exports&&"undefined"!=typeof module?s(exports):"function"==typeof define&&define.amd?define(["exports"],s):s((t="undefined"!=typeof globalThis?globalThis:t||self).SnapLineJs={})}(this,(function(t){"use strict";var s,i,h,e,n,r,l,o,a,u,c,d,f,p,g,m,b,w,v,_,D,E,W,M,y,x,C,R,k,L,A,I,O,P,T,X,j,S,Y,$,F,q,U,z,G,B,Q=Object.defineProperty,N=t=>{throw TypeError(t)},H=(t,s,i)=>((t,s,i)=>s in t?Q(t,s,{enumerable:!0,configurable:!0,writable:!0,value:i}):t[s]=i)(t,"symbol"!=typeof s?s+"":s,i),Z=(t,s,i)=>s.has(t)||N("Cannot "+i),K=(t,s,i)=>(Z(t,s,"read from private field"),i?i.call(t):s.get(t)),J=(t,s,i)=>s.has(t)?N("Cannot add the same private member more than once"):s instanceof WeakSet?s.add(t):s.set(t,i),V=(t,s,i,h)=>(Z(t,s,"write to private field"),h?h.call(t,i):s.set(t,i),i),tt=(t,s,i)=>(Z(t,s,"access private method"),i);class st{constructor(t,m={}){J(this,s),J(this,i),J(this,h),J(this,e),J(this,n),J(this,r),J(this,l),J(this,o),J(this,a),J(this,u),J(this,c),J(this,d),J(this,f),J(this,p),J(this,g);let b=t.getBoundingClientRect();V(this,s,t),V(this,i,b.left),V(this,h,b.top),V(this,e,b.width),V(this,n,b.height),V(this,f,K(this,e)/2),V(this,p,K(this,n)/2),V(this,r,0),V(this,l,0),V(this,o,0),V(this,a,0),V(this,u,1);V(this,c,{enableZoom:!0,zoomBounds:{min:.2,max:1},enablePan:!0,panBounds:{top:null,left:null,right:null,bottom:null},...m}),V(this,d,""),this.updateCamera(),K(this,c).handleResize,V(this,g,new ResizeObserver((()=>{this.updateCameraProperty()}))),K(this,g).observe(K(this,s)),K(this,g).observe(window.document.body),window.addEventListener("scroll",(()=>{this.updateCamera()}))}get cameraWidth(){return K(this,e)}get cameraHeight(){return K(this,n)}get cameraPositionX(){return K(this,r)}get cameraPositionY(){return K(this,l)}get zoom(){return K(this,u)}get containerOffsetX(){return K(this,i)}get containerOffsetY(){return K(this,h)}updateCameraProperty(){let t=K(this,s).getBoundingClientRect();V(this,i,t.left),V(this,h,t.top),V(this,e,t.width),V(this,n,t.height),V(this,f,K(this,e)/2+K(this,r)),V(this,p,K(this,n)/2+K(this,l))}worldToCameraMatrix(t,s,i){return`${i},0,0,0,0,${i},0,0,0,0,1,0,${-t*i},${-s*i},0,1`}updateCamera(){const t=this.worldToCameraMatrix(K(this,r),K(this,l),K(this,u));V(this,d,`matrix3d(${t})`)}get canvasStyle(){return K(this,d)}setCameraPosition(t,s){V(this,r,t),V(this,l,s),this.updateCamera()}setCameraCenterPosition(t,s){V(this,r,t-K(this,e)/2),V(this,l,s-K(this,n)/2),this.updateCamera()}getCameraCenterPosition(){return{x:K(this,r)+K(this,e)/2,y:K(this,l)+K(this,n)/2}}handleScroll(t,s,i){if(!K(this,c).enableZoom)return;K(this,u)+t<.2?t=.2-K(this,u):K(this,u)+t>1&&(t=1-K(this,u)),K(this,c).zoomBounds&&(K(this,u)+t<K(this,c).zoomBounds.min||K(this,u)+t>K(this,c).zoomBounds.max)&&(t=0);const h=K(this,u)/(K(this,u)+t);K(this,c).enablePan&&(V(this,r,K(this,r)-K(this,e)/K(this,u)*(h-1)*(1-(1.5*K(this,e)-s)/K(this,e))),V(this,l,K(this,l)-K(this,n)/K(this,u)*(h-1)*(1-(1.5*K(this,n)-i)/K(this,n)))),V(this,u,K(this,u)+t),this.updateCamera()}handlePan(t,s){K(this,c).enablePan&&(V(this,r,K(this,r)+t/K(this,u)),V(this,l,K(this,l)+s/K(this,u)),this.updateCamera())}handlePanStart(){K(this,c).enablePan&&(V(this,o,K(this,r)),V(this,a,K(this,l)))}handlePanDrag(t,s){K(this,c).enablePan&&(V(this,r,-t/K(this,u)+K(this,o)),V(this,l,-s/K(this,u)+K(this,a)),K(this,c).panBounds&&(null!==K(this,c).panBounds.left&&K(this,r)<K(this,c).panBounds.left&&V(this,r,K(this,c).panBounds.left+1),null!==K(this,c).panBounds.right&&K(this,r)>K(this,c).panBounds.right&&V(this,r,K(this,c).panBounds.right-1),null!==K(this,c).panBounds.top&&K(this,l)<K(this,c).panBounds.top&&V(this,l,K(this,c).panBounds.top-1),null!==K(this,c).panBounds.bottom&&K(this,l)>K(this,c).panBounds.bottom&&V(this,l,K(this,c).panBounds.bottom+1)),this.updateCamera())}handlePanEnd(){K(this,c).enablePan&&(V(this,o,0),V(this,a,0))}getCameraFromWorld(t,s){return[(t-K(this,r))*K(this,u),(s-K(this,l))*K(this,u)]}getScreenFromCamera(t,s){return[t+K(this,i),s+K(this,h)]}getWorldFromCamera(t,s){return[t/K(this,u)+K(this,r),s/K(this,u)+K(this,l)]}getCameraFromScreen(t,s){return[t-=K(this,i),s-=K(this,h)]}getCameraDeltaFromWorldDelta(t,s){return[t*K(this,u),s*K(this,u)]}getWorldDeltaFromCameraDelta(t,s){return[t/K(this,u),s/K(this,u)]}}function it(t,s){const i=s.getBoundingClientRect();if(null==t.camera)return{height:i.height,width:i.width,x:i.left,y:i.top,cameraX:i.left,cameraY:i.top,screenX:i.left,screenY:i.top};const[h,e]=t.camera.getCameraFromScreen(i.left,i.top),[n,r]=t.camera.getWorldFromCamera(h,e),[l,o]=t.camera.getCameraDeltaFromWorldDelta(i.width,i.height),[a,u]=t.camera.getWorldDeltaFromCameraDelta(l,o);return{height:u,width:a,x:n,y:r,cameraX:h,cameraY:e,screenX:i.left,screenY:i.top}}function ht(t){return`translate3d(${t.x}px, ${t.y}px, 0px) scale(${t.scaleX}, ${t.scaleY}) `}function et(t,s){Object.assign(t.style,s)}function nt(t,s,i=null){return new Proxy(s,{set:(s,i,h)=>(s[i]=null==h?null:h.bind(t),!0),get:(t,s)=>(...h)=>{var e,n;null==(e=t[s])||e.call(t,...h),null==(n=null==i?void 0:i[s])||n.call(i,...h)}})}s=new WeakMap,i=new WeakMap,h=new WeakMap,e=new WeakMap,n=new WeakMap,r=new WeakMap,l=new WeakMap,o=new WeakMap,a=new WeakMap,u=new WeakMap,c=new WeakMap,d=new WeakMap,f=new WeakMap,p=new WeakMap,g=new WeakMap;class rt{constructor(t,s,i){H(this,"owner"),H(this,"keyframe"),H(this,"property"),J(this,m),J(this,b),J(this,w),J(this,v),J(this,_),J(this,D),J(this,E),J(this,W),J(this,M),H(this,"requestDelete"),this.owner=t,this.keyframe=s,this.property=i,V(this,b,null),V(this,M,!0),this.property.duration||(this.property.duration=1e3),this.property.delay||(this.property.delay=0);let h=0;for(const[l,o]of Object.entries(this.keyframe)){const t=Array.isArray(o)?o.length:1;h=Math.max(h,t)}if(this.property.offset)V(this,v,this.property.offset);else{V(this,v,[]);for(let t=0;t<h;t++)K(this,v).push(t/(h-1))}this.property.easing?Array.isArray(this.property.easing)?V(this,_,this.property.easing):V(this,_,[this.property.easing]):V(this,_,["linear"]),this.property.duration&&Array.isArray(this.property.duration)?V(this,D,this.property.duration):V(this,D,[this.property.duration]),this.property.delay?V(this,E,this.property.delay):V(this,E,0),V(this,m,{}),V(this,w,[]),V(this,W,Object.keys(this.keyframe).filter((t=>t.startsWith("$"))).length>0);let e={};for(const[l,o]of Object.entries(this.keyframe))l.startsWith("$")?K(this,m)[l]=o:e[l]=o;K(this,W)&&0==Object.keys(e).length&&(e={}),this.property.offset&&(e.offset=this.property.offset);const n=this.owner instanceof dt?this.owner.t.element:this.owner.global.animationFragment,r={delay:K(this,E),fill:"both"};if(K(this,D).length>1?e.duration=K(this,D):r.duration=K(this,D)[0],K(this,_).length>1?e.easing=K(this,_):r.easing=K(this,_)[0],V(this,b,new Animation(new KeyframeEffect(n,e,r))),this.requestDelete=!1,K(this,b).onfinish=()=>{var t,s;null==(s=(t=this.property).finish)||s.call(t),this.finish(),K(this,b).cancel(),this.requestDelete=!0},V(this,w,[]),K(this,W)&&K(this,_).length>1)for(let l=0;l<K(this,v).length-1;l++){const t={};for(const[n,r]of Object.entries(K(this,m)))t[n]=r.slice(l,l+1);const s=(K(this,v)[l+1]-K(this,v)[l])*this.property.duration,i=K(this,v)[l]*this.property.duration+this.property.delay,h=K(this,_)[l],e=new Animation(new KeyframeEffect(n,t,{duration:s,delay:i,easing:h,fill:"both"}));e.onfinish=()=>{e.cancel()},e.persist(),K(this,w).push(e)}}pause(){K(this,b).pause();for(let t=0;t<K(this,w).length;t++)K(this,w)[t].pause()}play(){K(this,b).play();for(let t=0;t<K(this,w).length;t++)K(this,w)[t].play()}cancel(){K(this,b).cancel();for(let t=0;t<K(this,w).length;t++)K(this,w)[t].cancel()}reverse(){K(this,b).reverse();for(let t=0;t<K(this,w).length;t++)K(this,w)[t].reverse()}calculateFrame(t){var s,i,h,e;const n=K(this,b).effect.getComputedTiming().progress;if(null==n)return!1;const r=this.property.duration*n+this.property.delay;if(K(this,W)){let t=0;for(let s=0;s<K(this,v).length-1;s++)if(K(this,v)[s]<=n&&n<K(this,v)[s+1]){t=s;break}let h=n;if(K(this,_).length>1){const s=K(this,w)[t];s.currentTime=r,h=s.effect.getComputedTiming().progress??0}const e={};for(const[s,i]of Object.entries(K(this,m))){const n=i[t],r=n+(i[t+1]-n)*h;e[s]=r}null==(i=(s=this.property).tick)||i.call(s,e)}else null==(e=(h=this.property).tick)||e.call(h,{});return!1}finish(){var t;null==(t=K(this,b))||t.commitStyles()}set currentTime(t){K(this,b).currentTime=t;for(let s=0;s<K(this,w).length;s++)K(this,w)[s].currentTime=t}set progress(t){this.currentTime=(this.property.duration+this.property.delay)*t}}m=new WeakMap,b=new WeakMap,w=new WeakMap,v=new WeakMap,_=new WeakMap,D=new WeakMap,E=new WeakMap,W=new WeakMap,M=new WeakMap;class lt{constructor(){H(this,"animations"),H(this,"startTime"),H(this,"endTime"),H(this,"expired"),H(this,"requestDelete"),this.animations=[],this.startTime=-1,this.endTime=-1,this.expired=!1,this.requestDelete=!1}add(t){this.animations.push(t)}play(){for(let t=0;t<this.animations.length;t++)this.animations[t].play()}pause(){for(let t=0;t<this.animations.length;t++)this.animations[t].pause()}cancel(){for(let t=0;t<this.animations.length;t++)this.animations[t].cancel()}reverse(){for(let t=0;t<this.animations.length;t++)this.animations[t].reverse()}calculateFrame(t){let s=!1;for(let i=0;i<this.animations.length;i++)s=this.animations[i].calculateFrame(t)||s;return s}set currentTime(t){for(let s=0;s<this.animations.length;s++)this.animations[s].currentTime=t}set progress(t){for(let s=0;s<this.animations.length;s++)this.animations[s].progress=t}}let ot=class{constructor(t){H(this,"_object"),H(this,"_global"),H(this,"global"),H(this,"_input"),H(this,"input"),H(this,"_dom"),H(this,"dom"),this.i=t,this.h={pointerDown:null,pointerMove:null,pointerUp:null,mouseWheel:null,drag:null,pinch:null,dragStart:null,dragEnd:null,pinchStart:null,pinchEnd:null},this.global=new Proxy(this.h,{set:(t,s,i)=>{var h,e;return null==i?null==(h=this.i.global.inputEngine)||h.unsubscribeGlobalCursorEvent(s,this.i.gid):null==(e=this.i.global.inputEngine)||e.subscribeGlobalCursorEvent(s,this.i.gid,i.bind(this.i)),!0}}),this.l={pointerDown:null,pointerMove:null,pointerUp:null,mouseWheel:null,dragStart:null,drag:null,dragEnd:null,pinchStart:null,pinch:null,pinchEnd:null},this.input=nt(this.i,this.l),this.t={onAssignDom:null,onResize:null},this.dom=nt(this.i,this.t)}};class at{constructor(t,s,i=null){H(this,"uuid"),H(this,"object"),H(this,"callback"),this.uuid=i??t.global.getGlobalId(),this.object=t,this.callback=s?[s.bind(t)]:null}addCallback(t){this.callback?this.callback.push(t.bind(this.object)):this.callback=[t.bind(this.object)]}}class ut{constructor(t,s){H(this,"global"),H(this,"gid"),H(this,"parent"),H(this,"children",[]),H(this,"transform"),H(this,"local"),H(this,"offset"),H(this,"event"),H(this,"_requestPreRead",!1),H(this,"_requestWrite",!1),H(this,"_requestRead",!1),H(this,"_requestDelete",!1),H(this,"_requestPostWrite",!1),H(this,"_colliderList",[]),H(this,"_animationList",[]),H(this,"_globalInput"),H(this,"globalInput"),this.global=t,this.gid=t.getGlobalId(),this.global.objectTable[this.gid]=this,this.parent=s,this.o=[],this.transform={x:0,y:0,scaleX:1,scaleY:1},this.local={x:0,y:0,scaleX:1,scaleY:1},this.offset={x:0,y:0,scaleX:1,scaleY:1},this.event=new ot(this),this.u=!1,this.p=!1,this.m=!1,this.v=!1,this._=!1,this.D={pointerDown:null,pointerMove:null,pointerUp:null,mouseWheel:null,dragStart:null,drag:null,dragEnd:null,pinchStart:null,pinch:null,pinchEnd:null},this.globalInput=new Proxy(this.D,{set:(t,s,i)=>{var h,e;return null==i?null==(h=this.global.inputEngine)||h.unsubscribeGlobalCursorEvent(s,this.gid):null==(e=this.global.inputEngine)||e.subscribeGlobalCursorEvent(s,this.gid,i.bind(this)),!0}})}destroy(){delete this.global.objectTable[this.gid]}get worldPosition(){return[this.transform.x,this.transform.y]}set worldPosition(t){this.transform.x=t[0],this.transform.y=t[1]}get cameraPosition(){var t;return(null==(t=this.global.camera)?void 0:t.getCameraFromWorld(...this.worldPosition))??[0,0]}set cameraPosition(t){var s;this.worldPosition=(null==(s=this.global.camera)?void 0:s.getWorldFromCamera(...t))??[0,0]}get screenPosition(){var t;return(null==(t=this.global.camera)?void 0:t.getScreenFromCamera(...this.cameraPosition))??[0,0]}set screenPosition(t){var s;this.cameraPosition=(null==(s=this.global.camera)?void 0:s.getCameraFromScreen(...t))??[0,0]}queueUpdate(t="READ_1",s=null,i=null){let h=new at(this,s,i),e=this.global.read1Queue;switch(t){case"READ_1":e=this.global.read1Queue;break;case"WRITE_1":e=this.global.write1Queue;break;case"READ_2":e=this.global.read2Queue;break;case"WRITE_2":e=this.global.write2Queue;break;case"READ_3":e=this.global.read3Queue;break;case"WRITE_3":e=this.global.write3Queue}return e[this.gid]||(e[this.gid]=new Map),e[this.gid].set(h.uuid,h),h}readDom(t=!1){for(const s of this.o)s.read()}writeDom(){}writeTransform(){}destroyDom(){}calculateLocalFromTransform(){this.parent&&(this.transform.x=this.parent.transform.x+this.local.x,this.transform.y=this.parent.transform.y+this.local.y);for(const t of this.o)t.recalculate()}animate(t,s){let i=new rt(this,t,s);for(const h of this.W)h.cancel();return this.W=[],this.W.push(i),this.global.animationList.push(i),i}get animation(){return this.W[0]}animateSequence(t){let s=new lt;for(const i of t)s.add(i);return this.W=[],this.W.push(s),this.global.animationList.push(s),s}getCurrentStats(){return{timestamp:Date.now()}}addCollider(t){var s;this.o.push(t),null==(s=this.global.collisionEngine)||s.addObject(t)}addDebugPoint(t,s,i="red",h=!1,e=""){this.global.debugMarkerList[`${this.gid}-${e}`]={gid:this.gid,type:"point",color:i,x:t,y:s,persistent:h,id:`${this.gid}-${e}`}}addDebugRect(t,s,i,h,e="red",n=!1,r=""){this.global.debugMarkerList[`${this.gid}-${r}`]={gid:this.gid,type:"rect",color:e,x:t,y:s,width:i,height:h,persistent:n,id:`${this.gid}-${r}`}}addDebugCircle(t,s,i,h="red",e=!1,n=""){this.global.debugMarkerList[`${this.gid}-${n}`]={gid:this.gid,type:"circle",color:h,x:t,y:s,radius:i,persistent:e,id:`${this.gid}-${n}`}}addDebugText(t,s,i,h="red",e=!1,n=""){this.global.debugMarkerList[`${this.gid}-${n}`]={gid:this.gid,x:t,y:s,type:"text",color:h,text:i,persistent:e,id:`${this.gid}-${n}`}}clearDebugMarker(t){delete this.global.debugMarkerList[`${this.gid}-${t}`]}clearAllDebugMarkers(){for(const t of Object.values(this.global.debugMarkerList))t.gid==this.gid&&delete this.global.debugMarkerList[t.id]}}class ct{constructor(t,s,i=null,h={},e=!1){H(this,"_uuid"),H(this,"_global"),H(this,"_owner"),H(this,"element"),H(this,"_pendingInsert"),H(this,"_requestWrite",!1),H(this,"_requestRead",!1),H(this,"_requestDelete",!1),H(this,"_requestPostWrite",!1),H(this,"_style"),H(this,"_classList"),H(this,"_dataAttribute"),H(this,"property"),H(this,"_transformApplied"),H(this,"insertMode"),H(this,"resizeObserver",null),H(this,"mutationObserver",null),this.h=t,this.element=i,this.property={x:0,y:0,height:0,width:0,scaleX:1,scaleY:1,screenX:0,screenY:0},this.M={x:0,y:0,scaleX:1,scaleY:1},this.C=e,this.R=s,this.k=(++t.gid).toString(),this.p=!1,this.m=!1,this.v=!1,this._=!1,this.L={},this.A={},this.I=[],this.insertMode=h}addElement(t){this.element=t,this.R.requestWrite(),this.R.requestRead(),this.resizeObserver=new ResizeObserver((()=>{var t,s;null==(s=(t=this.R.event.dom).onResize)||s.call(t)})),this.resizeObserver.observe(t),this.mutationObserver=new MutationObserver((()=>{var t,s;null==(s=(t=this.R.event.dom).onResize)||s.call(t)}))}set style(t){this.L=Object.assign(this.L,t)}get style(){return this.L}set dataAttribute(t){this.A=Object.assign(this.A,t)}get dataAttribute(){return this.A}set classList(t){this.I=t}get classList(){return this.I}readDom(t=!1){if(!this.element)throw new Error("Element is not set");const s=it(this.h,this.element),i=this.element.style.transform;let h={x:0,y:0,scaleX:1,scaleY:1};i&&"none"!=i&&t&&(h=function(t){const s=t.split("(")[1].split(")")[0].split(",");return{x:parseFloat(s[0]),y:parseFloat(s[1]),scaleX:parseFloat(s[3])||1,scaleY:parseFloat(s[4])||1}}(i)),this.property.height=s.height/h.scaleY,this.property.width=s.width/h.scaleX,this.property.x=s.x-h.x,this.property.y=s.y-h.y,this.property.screenX=s.screenX,this.property.screenY=s.screenY}writeDom(){if(this.element){et(this.element,this.L),this.element.classList.forEach((t=>{this.element.classList.add(t)}));for(const[t,s]of Object.entries(this.A))this.element.setAttribute(`data-${t}`,s);this.element.setAttribute("data-snapline-gid",this.R.gid)}}writeTransform(){if(!this.element)return;let t={transform:""};if("direct"==this.R.transformMode)t={transform:ht({x:this.R.transform.x+this.R.offset.x,y:this.R.transform.y+this.R.offset.y,scaleX:this.R.transform.scaleX,scaleY:this.R.transform.scaleY})};else if("relative"==this.R.transformMode){let[s,i]=[this.R.transform.x-this.property.x,this.R.transform.y-this.property.y];t={transform:ht({x:s+this.R.offset.x,y:i+this.R.offset.y,scaleX:this.R.transform.scaleX,scaleY:this.R.transform.scaleY})}}else if("none"==this.R.transformMode)t={transform:""};else if("offset"==this.R.transformMode){if(!this.R.transformOrigin)throw new Error("Transform origin is not set");t={transform:ht({x:this.R.transform.x-this.R.transformOrigin.transform.x,y:this.R.transform.y-this.R.transformOrigin.transform.y,scaleX:this.R.transform.scaleX*this.R.transformOrigin.transform.scaleX,scaleY:this.R.transform.scaleY*this.R.transformOrigin.transform.scaleY})}}null!=this.L.transform&&""!=this.L.transform&&""!=t.transform&&(t.transform=this.L.transform),et(this.element,{...this.L,...t})}destroyDom(){var t,s;null==(t=this.resizeObserver)||t.disconnect(),null==(s=this.mutationObserver)||s.disconnect(),this.element&&this.element.remove()}}class dt extends ut{constructor(t,s){super(t,s),H(this,"_dom"),H(this,"_requestWrite"),H(this,"_requestRead"),H(this,"_requestDelete"),H(this,"_requestPostWrite"),H(this,"_state",{}),H(this,"state"),H(this,"transformMode"),H(this,"transformOrigin"),H(this,"_domProperty"),H(this,"inScene",!1),H(this,"_callback"),H(this,"callback"),H(this,"inputEngine"),this.t=new ct(t,this,null),this.inScene=!1,this.p=!1,this.m=!1,this.v=!1,this._=!1,this.O=[{x:0,y:0,height:0,width:0,scaleX:1,scaleY:1,screenX:0,screenY:0},{x:0,y:0,height:0,width:0,scaleX:1,scaleY:1,screenX:0,screenY:0},{x:0,y:0,height:0,width:0,scaleX:1,scaleY:1,screenX:0,screenY:0}],this.transformMode="direct",this.transformOrigin=null,this.P={afterRead1:null,afterRead2:null,afterRead3:null,afterWrite1:null,afterWrite2:null,afterWrite3:null},this.callback=nt(this,this.P),this.state=new Proxy(this.T,{set:(t,s,i)=>(t[s]=i,!0)}),this.inputEngine=new pt(this.global,!1,this.gid)}destroy(){this.t.destroyDom(),super.destroy()}getDomProperty(t=null){const s="READ_1"==t?0:"READ_2"==t?1:2;return this.O[s]}saveDomPropertyToTransform(t=null){let s=t??this.global.currentStage;s="IDLE"==s?"READ_2":s;const i=this.getDomProperty(s);this.worldPosition=[i.x,i.y]}calculateLocalFromTransform(){this.parent&&(this.local.x=this.transform.x-this.parent.transform.x,this.local.y=this.transform.y-this.parent.transform.y)}calculateLocalFromDom(t=null){if(this.parent){const s=this.getDomProperty(t);this.parent instanceof dt?(this.local.x=s.x-this.parent.getDomProperty(t).x,this.local.y=s.y-this.parent.getDomProperty(t).y):(this.local.x=this.transform.x-this.parent.transform.x,this.local.y=this.transform.y-this.parent.transform.y)}}calculateTransformFromLocal(){this.parent&&(this.transform.x=this.parent.transform.x+this.local.x,this.transform.y=this.parent.transform.y+this.local.y)}get style(){return this.t.style}set style(t){this.t.style=t}get classList(){return this.t.classList}set classList(t){this.t.classList=t}get dataAttribute(){return this.t.dataAttribute}set dataAttribute(t){this.t.dataAttribute=t}get element(){return this.t.element}set element(t){var s,i,h,e;if(!t)return;this.t.addElement(t),null==(s=this.inputEngine)||s.addCursorEventListener(t);const n=Object.keys(this.inputEngine.event);for(const r of n){let t=(null==(i=this.event.input[r])?void 0:i.bind(this))||null;this.inputEngine.event[r]=t}null==(e=(h=this.event.dom).onAssignDom)||e.call(h)}readDom(t=!1,s=null){let i=s??this.global.currentStage;i="IDLE"==i?"READ_2":i,this.t.readDom(t),super.readDom(t),"READ_1"==i?Object.assign(this.O[0],this.t.property):"READ_2"==i?Object.assign(this.O[1],this.t.property):"READ_3"==i&&Object.assign(this.O[2],this.t.property)}writeDom(){this.t.writeDom(),super.writeDom()}writeTransform(){this.t.writeTransform(),super.writeTransform()}destroyDom(){this.t.destroyDom(),super.destroyDom()}requestRead(t=!1,s=!0,i="READ_1"){return this.queueUpdate(i,(()=>{this.readDom(t),s&&this.saveDomPropertyToTransform(i)}),i)}requestWrite(t=!0,s=null,i="WRITE_1"){return this.queueUpdate(i,(()=>{t&&this.writeDom(),null==s||s()}),i)}requestDestroy(){return this.queueUpdate("WRITE_2",(()=>{this.destroyDom()}),"destroy")}requestTransform(t="WRITE_2"){return this.queueUpdate(t,(()=>{this.writeTransform()}),"transform")}requestFLIP(t,s){this.requestRead(!1,!0,"READ_1"),this.requestWrite(!0,t,"WRITE_1"),this.requestRead(!1,!0,"READ_2"),this.requestWrite(!1,s,"WRITE_2")}}const ft="global";class pt{constructor(t,s=!0,i=null){var h;J(this,C),H(this,"_element"),H(this,"global"),H(this,"_sortedTouchArray"),H(this,"_sortedTouchDict"),H(this,"_localPointerDict"),H(this,"_event"),H(this,"event"),H(this,"_isGlobal"),H(this,"_uuid"),H(this,"_ownerGID"),J(this,y),J(this,x),this.global=t,this.X=null,this.j=s,this.S=[],this.Y={},this.$=i,this.F={},V(this,x,[]),this.q={pointerDown:null,pointerMove:null,pointerUp:null,mouseWheel:null,dragStart:null,drag:null,dragEnd:null,pinchStart:null,pinch:null,pinchEnd:null},this.event=nt(this,this.q,this.j?null:null==(h=this.globalInputEngine)?void 0:h.U.event),this.k=Symbol(),V(this,y,new ut(this.global,null))}destroy(){}get globalInputEngine(){var t;return null==(t=this.global)?void 0:t.inputEngine}get globalPointerDict(){return null==this.globalInputEngine?{}:this.globalInputEngine.G}get globalGestureDict(){return null==this.globalInputEngine?{}:this.globalInputEngine.B}getCoordinates(t,s){if(null==this.global)return{x:t,y:s,cameraX:t,cameraY:s,screenX:t,screenY:s};const[i,h]=this.global.camera.getCameraFromScreen(t,s),[e,n]=this.global.camera.getWorldFromCamera(i,h);return{x:e,y:n,cameraX:i,cameraY:h,screenX:t,screenY:s}}onPointerDown(t){var s,i,h,e;t.stopPropagation();const n=this.getCoordinates(t.clientX,t.clientY);null==(i=(s=this.event).pointerDown)||i.call(s,{event:t,position:n,gid:this.j?ft:this.$,button:t.buttons});const r={id:t.pointerId,callerGID:this.j?ft:this.$,timestamp:t.timeStamp,x:t.clientX,y:t.clientY,startX:t.clientX,startY:t.clientY,prevX:t.clientX,prevY:t.clientY,endX:null,endY:null,moveCount:0};this.globalPointerDict[t.pointerId]=r,null==(e=(h=this.event).dragStart)||e.call(h,{gid:this.j?ft:this.$,pointerId:t.pointerId,start:n,button:t.buttons}),K(this,y).addDebugPoint(n.x,n.y,"red",!0,"pointerDown"),this.globalGestureDict[t.pointerId]?this.globalGestureDict[t.pointerId].memberList.push(this):this.globalGestureDict[t.pointerId]={type:"drag",state:"drag",memberList:[this,...K(this,x)],initiatorID:this.j?ft:this.$??""}}onPointerMove(t){var s,i;t.preventDefault();const h=this.getCoordinates(t.clientX,t.clientY);null==(i=(s=this.event).pointerMove)||i.call(s,{event:t,position:h,gid:this.j?ft:this.$,button:t.buttons});const e=t.pointerId;let n=this.globalPointerDict[e];if(null!=n){const s={prevX:n.x,prevY:n.y,x:t.clientX,y:t.clientY,callerGID:this.j?ft:this.$};Object.assign(n,s),tt(this,C,R).call(this,t)}t.stopPropagation()}onPointerUp(t){var s,i,h,e,n,r;t.preventDefault();const l=this.getCoordinates(t.clientX,t.clientY);null==(i=(s=this.event).pointerUp)||i.call(s,{event:t,position:l,gid:this.j?ft:this.$,button:t.buttons});let o=this.globalPointerDict[t.pointerId];if(null!=o){const s=this.globalGestureDict[t.pointerId];if(null!=s){s.state="release";const i=this.getCoordinates(o.startX,o.startY);for(const n of s.memberList)null==(e=(h=n.event).dragEnd)||e.call(h,{gid:this.j?ft:this.$,pointerId:t.pointerId,start:i,end:l,button:t.buttons});delete this.globalGestureDict[t.pointerId]}delete this.globalPointerDict[t.pointerId];for(const i of Object.keys(this.globalGestureDict)){if(!i.includes("-"))continue;const[s,h]=i.split("-").map(Number);if(s==t.pointerId||h==t.pointerId){const t=this.globalGestureDict[i];null==(r=(n=this.event).pinchEnd)||r.call(n,{gid:this.j?ft:this.$,gestureID:i,start:t.start,pointerList:t.pointerList,distance:t.distance,end:{pointerList:t.pointerList,distance:t.distance}}),delete this.globalGestureDict[i]}}}t.stopPropagation()}onWheel(t){var s,i;const h=this.getCoordinates(t.clientX,t.clientY);null==(i=(s=this.event).mouseWheel)||i.call(s,{event:t,position:h,delta:t.deltaY,gid:this.j?ft:this.$}),t.stopPropagation()}addListener(t,s,i){t.addEventListener(s,i.bind(this))}addCursorEventListener(t){this.addListener(t,"pointerdown",this.onPointerDown),this.addListener(t,"pointermove",this.onPointerMove),this.addListener(t,"pointerup",this.onPointerUp),this.addListener(t,"wheel",this.onWheel)}addDragMember(t){K(this,x).push(t)}resetDragMembers(){V(this,x,[])}}y=new WeakMap,x=new WeakMap,C=new WeakSet,R=function(t){var s,i,h,e,n,r;const l=Object.keys(this.globalPointerDict).length;if(l>=1)for(const o of Object.values(this.globalPointerDict)){if((this.j?ft:this.$)!=o.callerGID)continue;const h=this.getCoordinates(o.startX,o.startY),e=this.getCoordinates(o.x,o.y),n={x:e.x-h.x,y:e.y-h.y,cameraX:e.cameraX-h.cameraX,cameraY:e.cameraY-h.cameraY,screenX:e.screenX-h.screenX,screenY:e.screenY-h.screenY};o.moveCount,o.moveCount++;const r=this.globalGestureDict[o.id];for(const l of r.memberList)null==(i=(s=l.event).drag)||i.call(s,{gid:l.j?ft:l.$,pointerId:o.id,start:h,position:e,delta:n,button:t.buttons})}if(l>=2&&this.j){const t=Object.values(this.globalPointerDict);t.sort(((t,s)=>t.timestamp-s.timestamp));for(let s=0;s<t.length-1;s++){const i=t[s],l=t[s+1],o=`${i.id}-${l.id}`,a=(i.startX+l.startX)/2,u=(i.startY+l.startY)/2,c=(this.getCoordinates(a,u),Math.sqrt(Math.pow(i.startX-l.startX,2)+Math.pow(i.startY-l.startY,2))),d=this.getCoordinates(i.x,i.y),f=this.getCoordinates(l.x,l.y),p=Math.sqrt(Math.pow(i.x-l.x,2)+Math.pow(i.y-l.y,2));null==this.globalGestureDict[o]&&(this.globalGestureDict[o]={type:"pinch",state:"pinch",memberList:[this],start:{pointerList:[d,f],distance:c},pointerList:[d,f],distance:c},null==(e=(h=this.event).pinchStart)||e.call(h,{gid:this.j?ft:this.$,gestureID:o,start:{pointerList:[d,f],distance:c}}));const g=this.globalGestureDict[o];g.pointerList=[d,f],g.distance=p,null==(r=(n=this.event).pinch)||r.call(n,{gid:this.j?ft:this.$,gestureID:o,start:g.start,pointerList:g.pointerList,distance:g.distance})}}};class gt{constructor(t=null){J(this,k),H(this,"global"),H(this,"_inputControl"),H(this,"globalCallbacks"),H(this,"_pointerDict"),H(this,"_gestureDict"),H(this,"_event"),H(this,"event"),this.global=t,V(this,k,document),this.U=new pt(this.global,!0,null),this.U.addCursorEventListener(K(this,k)),this.globalCallbacks={pointerDown:{},pointerMove:{},pointerUp:{},mouseWheel:{},dragStart:{},drag:{},dragEnd:{},pinchStart:{},pinch:{},pinchEnd:{}},this.G={},this.B={};for(const[s,i]of Object.entries(this.globalCallbacks))this.U.event[s]=t=>{for(const i of Object.values(this.globalCallbacks[s]))i(t)};this.q={pointerDown:null,pointerMove:null,pointerUp:null,mouseWheel:null,dragStart:null,drag:null,dragEnd:null,pinchStart:null,pinch:null,pinchEnd:null},this.event=new Proxy(this.q,{set:(t,s,i)=>(null!=i?this.subscribeGlobalCursorEvent(s,ft,i.bind(this)):this.unsubscribeGlobalCursorEvent(s,ft),!0)})}subscribeGlobalCursorEvent(t,s,i){this.globalCallbacks[t][s]=i}unsubscribeGlobalCursorEvent(t,s){delete this.globalCallbacks[t][s]}}k=new WeakMap;class mt{constructor(t){H(this,"_object"),H(this,"_collider"),H(this,"collider"),this.i=t,this.N={onCollide:null,onBeginContact:null,onEndContact:null},this.collider=nt(t,this.N)}}class bt{constructor(t,s,i,h,e){H(this,"global"),H(this,"parent"),H(this,"type"),H(this,"uuid"),H(this,"_element"),H(this,"inputEngine"),H(this,"transform"),H(this,"event"),H(this,"_currentCollisions"),H(this,"_iterationCollisions"),this.global=t,this.parent=s,this.type=i,this.uuid=Symbol(),this.X=null,this.transform={x:h,y:e,width:0,height:0},this.event=new mt(this.parent),this.H=new Set,this.Z=new Set,this.recalculate(),this.inputEngine=new pt(this.global)}get worldPosition(){return[this.parent.transform.x+this.transform.x,this.parent.transform.y+this.transform.y]}set worldPosition([t,s]){this.transform.x=t-this.parent.transform.x,this.transform.y=s-this.parent.transform.y}set element(t){this.X=t,this.parent.hasOwnProperty("element")?this.parent.requestRead():this.recalculate()}read(){if(!this.element)return;const t=it(this.global,this.element);this.transform.x=t.x-this.parent.transform.x,this.transform.y=t.y-this.parent.transform.y,this.transform.width=t.width,this.transform.height=t.height}recalculate(){}}class wt extends bt{constructor(t,s,i,h,e,n){super(t,s,"rect",i,h),this.transform.width=e,this.transform.height=n}}class vt extends bt{constructor(t,s,i,h,e){super(t,s,"circle",i,h),H(this,"radius"),this.radius=e}}class _t extends bt{constructor(t,s,i,h){super(t,s,"point",i,h)}}class Dt{constructor(){H(this,"objectTable",{}),H(this,"objectList",[]),H(this,"sortedXCoordinates",[]),this.sortedXCoordinates=[]}addObject(t){this.objectTable[t.uuid]=t,this.objectList.push(t),this.sortedXCoordinates.push({collider:t,x:t.worldPosition[0],left:!0}),this.sortedXCoordinates.push({collider:t,x:t.worldPosition[0]+(t.transform.width??0),left:!1})}removeObject(t){delete this.objectTable[t],this.objectList=this.objectList.filter((s=>s.uuid!==t))}updateXCoordinates(){for(const t of this.sortedXCoordinates)t.left?"circle"===t.collider.type?t.x=t.collider.worldPosition[0]-t.collider.radius:("rect"===t.collider.type||"point"===t.collider.type)&&(t.x=t.collider.worldPosition[0]):"circle"===t.collider.type?t.x=t.collider.worldPosition[0]+t.collider.radius:"rect"===t.collider.type?t.x=t.collider.worldPosition[0]+t.collider.transform.width:"point"===t.collider.type&&(t.x=t.collider.worldPosition[0])}sortXCoordinates(){this.sortedXCoordinates.sort(((t,s)=>t.x-s.x))}detectCollisions(){var t,s;this.updateXCoordinates(),this.sortXCoordinates();let i=new Set;for(const h of this.sortedXCoordinates)if(h.left){for(const t of i)this.isIntersecting(h.collider,t)&&(this.onColliderCollide(h.collider,t),this.onColliderCollide(t,h.collider));i.add(h.collider)}else i.delete(h.collider);for(const h of this.sortedXCoordinates)if(h.left){for(const i of h.collider.Z)h.collider.H.has(i)||(null==(s=(t=h.collider.event.collider).onEndContact)||s.call(t,h.collider,i),h.collider.Z.delete(i));h.collider.H.clear()}}isIntersecting(t,s){const i=t,h=s;return"rect"===i.type&&"rect"===h.type?this.isRectIntersecting(i,h):"circle"===i.type&&"circle"===h.type?this.isCircleIntersecting(i,h):"rect"===i.type&&"circle"===h.type?this.isRectCircleIntersecting(i,h):"circle"===i.type&&"rect"===h.type?this.isRectCircleIntersecting(h,i):"rect"===i.type&&"point"===h.type?this.isRectPointIntersecting(i,h):"point"===i.type&&"rect"===h.type?this.isRectPointIntersecting(h,i):"point"===i.type&&"circle"===h.type?this.isCirclePointIntersecting(h,i):"circle"===i.type&&"point"===h.type?this.isCirclePointIntersecting(i,h):"point"===i.type&&"point"===h.type&&this.isPointPointIntersecting(i,h)}onColliderCollide(t,s){var i,h;t.event.collider.onCollide&&t.event.collider.onCollide(t,s),t.Z.has(s)||(null==(h=(i=t.event.collider).onBeginContact)||h.call(i,t,s),t.Z.add(s)),t.H.add(s)}isRectIntersecting(t,s){return t.uuid!==s.uuid&&t.worldPosition[1]<s.worldPosition[1]+s.transform.height&&t.worldPosition[1]+t.transform.height>s.worldPosition[1]}isRectCircleIntersecting(t,s){let i=s.worldPosition[0],h=s.worldPosition[1];s.worldPosition[0]<t.worldPosition[0]?i=t.worldPosition[0]:s.worldPosition[0]>t.worldPosition[0]+t.transform.width&&(i=t.worldPosition[0]+t.transform.width),s.worldPosition[1]<t.worldPosition[1]?h=t.worldPosition[1]:s.worldPosition[1]>t.worldPosition[1]+t.transform.height&&(h=t.worldPosition[1]+t.transform.height);let e=s.worldPosition[0]-i,n=s.worldPosition[1]-h;return Math.sqrt(e*e+n*n)<=(s.radius??0)}isRectPointIntersecting(t,s){return s.worldPosition[0]>=t.worldPosition[0]&&s.worldPosition[0]<=t.worldPosition[0]+t.transform.width&&s.worldPosition[1]>=t.worldPosition[1]&&s.worldPosition[1]<=t.worldPosition[1]+t.transform.height}isCirclePointIntersecting(t,s){let i=t.worldPosition[0]-s.worldPosition[0],h=t.worldPosition[1]-s.worldPosition[1];return Math.sqrt(i*i+h*h)<=(t.radius??0)}isCircleIntersecting(t,s){if(t.uuid===s.uuid)return!1;let i=t.worldPosition[0]-s.worldPosition[0],h=t.worldPosition[1]-s.worldPosition[1];return Math.sqrt(i*i+h*h)<=(t.radius??0)+(s.radius??0)}isPointPointIntersecting(t,s){return t.uuid!==s.uuid&&(t.worldPosition[0]===s.worldPosition[0]&&t.worldPosition[1]===s.worldPosition[1])}}class Et{constructor(){H(this,"containerElement"),H(this,"cursor"),H(this,"camera"),H(this,"inputEngine"),H(this,"collisionEngine"),H(this,"objectTable"),H(this,"currentStage"),H(this,"read1Queue"),H(this,"write1Queue"),H(this,"read2Queue"),H(this,"write2Queue"),H(this,"read3Queue"),H(this,"write3Queue"),H(this,"animationList",[]),H(this,"animationFragment"),H(this,"debugMarkerList",{}),H(this,"data"),H(this,"snapline"),H(this,"gid"),this.containerElement=null,this.cursor={worldX:0,worldY:0,cameraX:0,cameraY:0,screenX:0,screenY:0},this.camera=null,this.collisionEngine=null,this.objectTable={},this.inputEngine=new gt(this),this.currentStage="IDLE",this.read1Queue={},this.write1Queue={},this.read2Queue={},this.write2Queue={},this.read3Queue={},this.write3Queue={},this.animationList=[],this.animationFragment=document.createElement("div"),document.body.appendChild(this.animationFragment),this.data={},this.snapline=null,this.gid=0}getGlobalId(){return this.gid++,this.gid.toString()}}L=new WeakMap,A=new WeakMap,I=new WeakSet,O=function(){this.K(),window.requestAnimationFrame(tt(this,I,O).bind(this))},P=function(t,s){var i,h,e,n,r,l,o,a,u,c,d,f;let p=new Set;for(const g of Object.values(s))for(const s of g.values())if(s.callback){for(const t of s.callback)t();p.has(s.object)||(p.add(s.object),s.object instanceof dt&&("READ_1"==t?null==(h=(i=s.object.callback).afterRead1)||h.call(i):"READ_2"==t?null==(n=(e=s.object.callback).afterRead2)||n.call(e):"READ_3"==t?null==(l=(r=s.object.callback).afterRead3)||l.call(r):"WRITE_1"==t?null==(a=(o=s.object.callback).afterWrite1)||a.call(o):"WRITE_2"==t?null==(c=(u=s.object.callback).afterWrite2)||c.call(u):"WRITE_3"==t&&(null==(f=(d=s.object.callback).afterWrite3)||f.call(d))))}};class Wt extends dt{constructor(t,s){super(t,s),H(this,"endWorldX"),H(this,"endWorldY"),H(this,"start"),H(this,"target"),this.endWorldX=0,this.endWorldY=0,this.start=s,this.target=null,this.transformMode="direct"}setLineStartAtConnector(){const t=this.start.center;this.setLineStart(t.x,t.y)}setLineEndAtConnector(){if(this.target){const t=this.target.center;this.setLineEnd(t.x,t.y)}}setLineStart(t,s){this.worldPosition=[t,s]}setLineEnd(t,s){this.endWorldX=t,this.endWorldY=s}setLinePosition(t,s,i,h){this.setLineStart(t,s),this.setLineEnd(i,h)}moveLineToConnectorTransform(){this.setLineStartAtConnector(),this.target&&this.setLineEndAtConnector()}}T=new WeakMap,X=new WeakMap,j=new WeakMap,S=new WeakMap,Y=new WeakMap,$=new WeakMap,F=new WeakMap,q=new WeakMap,U=new WeakMap,z=new WeakMap;let Mt=class t extends dt{constructor(t,s,i={}){super(t,s),J(this,T),J(this,X),J(this,j),J(this,S),J(this,Y),J(this,$,0),J(this,F),J(this,q),J(this,U,null),J(this,z,null),V(this,j,{}),V(this,S,[]),V(this,Y,[]),V(this,T,i),V(this,X,i.name||this.gid||""),this.event.input.pointerDown=this.onCursorDown,V(this,F,new vt(t,this,0,0,30)),this.addCollider(K(this,F)),V(this,q,new _t(t,this,0,0)),this.addCollider(K(this,q)),V(this,U,null),this.transformMode="none",V(this,z,{onConnectOutgoing:null,onConnectIncoming:null,onDisconnectOutgoing:null,onDisconnectIncoming:null}),V(this,z,nt(this,K(this,z)))}get name(){return K(this,X)}get config(){return K(this,T)}get prop(){return K(this,j)}get outgoingLines(){return K(this,S)}get incomingLines(){return K(this,Y)}get targetConnector(){return K(this,U)}set targetConnector(t){V(this,U,t)}get numIncomingLines(){return K(this,Y).length}get numOutgoingLines(){return K(this,S).length}get center(){const t=this.getDomProperty("READ_1");return{x:this.transform.x+t.width/2,y:this.transform.y+t.height/2}}get connectorCallback(){return K(this,z)}onCursorDown(t){const s=K(this,Y).filter((t=>!t.v));0==t.event.button&&(this.inputEngine.resetDragMembers(),s.length>0?this.startPickUpLine(s[0],t):K(this,T).allowDragOut&&this.startDragOutLine(t))}deleteLine(t){if(0==K(this,S).length)return null;const s=K(this,S)[t];return s.destroy(),K(this,S).splice(t,1),s}deleteAllLines(){for(const t of K(this,S))t.destroy()}updateAllLines(){var t;this.calculateTransformFromLocal();for(const s of[...K(this,S),...K(this,Y)])null==(t=s.target)||t.calculateTransformFromLocal(),s.calculateLocalFromTransform(),s.moveLineToConnectorTransform(),s.requestTransform("WRITE_2")}assignToNode(t){this.parent=t,t.children.push(this);let s=this.parent;s.J[K(this,X)]=null,V(this,j,s.J),s.V[K(this,X)]=this,V(this,S,[]),V(this,Y,[]),s.global&&null==this.global&&(this.global=s.global)}createLine(){let t;return t=K(this,T).lineClass?new(K(this,T).lineClass)(this.global,this):new Wt(this.global,this),this.children.push(t),t}startDragOutLine(t){let s=this.createLine();s.setLineEnd(t.position.x,t.position.y),s.setLineStartAtConnector(),K(this,S).unshift(s),this.parent.updateNodeLines(),this.parent.updateNodeLineList(),V(this,$,1),V(this,U,null),this.event.input.drag=this.runDragOutLine,this.event.input.dragEnd=this.endDragOutLine,K(this,q).event.collider.onCollide=(t,s)=>{this.findClosestConnector()},K(this,q).event.collider.onEndContact=(t,s)=>{var i;(null==(i=K(this,U))?void 0:i.gid)==s.parent.gid&&V(this,U,null)},this.runDragOutLine({position:t.position,start:{x:this.transform.x,y:this.transform.y},delta:{x:t.position.x-this.transform.x,y:t.position.y-this.transform.y}})}findClosestConnector(){let s=Array.from(K(this,q).Z).filter((s=>s.parent instanceof t)).map((t=>t.parent)).sort(((t,s)=>{const i=t.center,h=s.center;return Math.sqrt(Math.pow(i.x-K(this,q).transform.x,2)+Math.pow(i.y-K(this,q).transform.y,2))-Math.sqrt(Math.pow(h.x-K(this,q).transform.x,2)+Math.pow(h.y-K(this,q).transform.y,2))}));s.length>0?V(this,U,s[0]):V(this,U,null)}runDragOutLine(t){if(1!=K(this,$))return;if(0==K(this,S).length)return;K(this,q).transform.x=t.position.x-this.transform.x,K(this,q).transform.y=t.position.y-this.transform.y;let s=K(this,S)[0];if(K(this,U)){const t=this.hoverWhileDragging(K(this,U));if(t)return s.setLineEnd(t[0],t[1]),s.setLineStartAtConnector(),void s.requestTransform("WRITE_2")}s.setLineEnd(t.position.x,t.position.y),s.setLineStartAtConnector(),this.parent.updateNodeLines()}hoverWhileDragging(s){if(!(s instanceof t))return;if(null==s)return;if(s.gid==this.gid)return;const i=s.center;return[i.x,i.y]}endDragOutLine(s){if(this.inputEngine.resetDragMembers(),K(this,U)&&K(this,U)instanceof t){const t=K(this,U);if(null==t)return void this.tt();if(0==this.connectToConnector(t,K(this,S)[0]))return this.tt(),void this.deleteLine(0);K(t,j)[K(t,X)]=K(this,j)[K(this,X)],K(this,S)[0].setLineEnd(t.transform.x,t.transform.y)}else this.deleteLine(0);this.parent&&this.parent.updateNodeLines(),this.tt()}tt(){V(this,$,0),this.event.global.pointerMove=null,this.event.global.pointerUp=null,this.parent.updateNodeLineList(),V(this,U,null),K(this,q).event.collider.onBeginContact=null,K(this,q).event.collider.onEndContact=null,K(this,q).transform.x=0,K(this,q).transform.y=0}startPickUpLine(t,s){t.start.disconnectFromConnector(this),this.disconnectFromConnector(t.start),t.start.deleteLine(t.start.outgoingLines.indexOf(t)),this.inputEngine.resetDragMembers(),this.inputEngine.addDragMember(t.start.inputEngine),t.start.targetConnector=this,t.start.startDragOutLine(s),V(this,$,1)}connectToConnector(t,s){var i,h,e,n;const r=t.incomingLines.filter((t=>!t.v));return!r.some((t=>t.start==this))&&(t.config.maxConnectors!==r.length&&(null==s&&(s=this.createLine(),K(this,S).unshift(s)),this.calculateLocalFromTransform(),s.target=t,t.incomingLines.push(s),this.parent.updateNodeLineList(),null==(h=null==(i=K(this,z))?void 0:i.onConnectOutgoing)||h.call(i,t),null==(n=null==(e=K(t,z))?void 0:e.onConnectIncoming)||n.call(e,this),this.parent.setProp(K(this,X),K(this,j)[K(this,X)]),!0))}disconnectFromConnector(t){var s,i,h,e;for(const n of K(this,S))if(n.target==t){n.v=!0;break}null==(i=null==(s=K(this,z))?void 0:s.onDisconnectOutgoing)||i.call(s,t),null==(e=null==(h=K(t,z))?void 0:h.onDisconnectIncoming)||e.call(h,this)}};class yt extends dt{constructor(t,s,i={}){super(t,s),H(this,"_config"),H(this,"_connectors"),H(this,"_components"),H(this,"_nodeWidth",0),H(this,"_nodeHeight",0),H(this,"_dragStartX",0),H(this,"_dragStartY",0),H(this,"_prop"),H(this,"_propSetCallback"),H(this,"_nodeStyle"),H(this,"_lineListCallback"),H(this,"_hitBox"),H(this,"_selected"),H(this,"_mouseDownX"),H(this,"_mouseDownY"),H(this,"_hasMoved"),this.st=i,this.V={},this.it={},this.ht=this.transform.x,this.et=this.transform.y,this.nt=0,this.rt=0,this.J={},this.lt={},this.ot=null,this.transformMode="direct",this.event.input.pointerDown=this.onCursorDown,this.event.input.dragStart=this.onDragStart,this.event.input.drag=this.onDrag,this.event.input.dragEnd=this.onDragEnd,this.event.input.pointerUp=this.onUp,this.ut=new wt(this.global,this,0,0,0,0),this.addCollider(this.ut),this.ct=!1,this.dt=!1,this.event.dom.onResize=()=>{this.queueUpdate("READ_1",(()=>{this.readDom(!1,"READ_1");for(const t of Object.values(this.V))t.readDom(!1,"READ_1"),t.calculateLocalFromDom("READ_1"),t.calculateTransformFromLocal()}));for(const t of[...this.getAllOutgoingLines(),...this.getAllIncomingLines()])t.queueUpdate("WRITE_1",(()=>{t.moveLineToConnectorTransform(),t.setLineEndAtConnector(),t.writeDom(),t.writeTransform()}))},this.style={willChange:"transform",position:"absolute",transformOrigin:"top left"},this.event.dom.onAssignDom=()=>{this.ut.element=this.element}}setStartPositions(){this.ht=this.transform.x,this.et=this.transform.y}setSelected(t){this.ct=t,this.dataAttribute={selected:t},t?this.global.data.select.push(this):(this.classList=this.classList.filter((t=>"selected"!==t)),this.global.data.select=this.global.data.select.filter((t=>t.gid!==this.gid))),this.requestWrite()}ft(t){for(let s=0;s<t.length;s++)t[s].v&&(t.splice(s,1),s--)}updateNodeLines(){for(const t of Object.values(this.V))t.updateAllLines()}updateNodeLineList(){this.ot&&this.ot(this.getAllOutgoingLines())}setLineListCallback(t){this.ot=t}onCursorDown(t){var s;if(0==t.event.button&&0==(null==(s=this.global.data.select)?void 0:s.includes(this))){for(const t of this.global.data.select)t.setSelected(!1);this.setSelected(!0)}}onDragStart(t){for(const s of this.global.data.select??[])s.setStartPositions(),s.nt=t.start.x,s.rt=t.start.y;this.dt=!0}onDrag(t){if(null!=this.global&&!this.st.lockPosition)for(const s of this.global.data.select??[])s.setDragPosition(t)}setDragPosition(t){const s=t.position.x-this.nt,i=t.position.y-this.rt;this.worldPosition=[this.ht+s,this.et+i],this.updateNodeLines(),this.requestTransform("WRITE_2")}onDragEnd(t){for(const s of this.global.data.select??[])s.setUpPosition(t)}setUpPosition(t){const[s,i]=[t.end.x-this.nt,t.end.y-this.rt];this.worldPosition=[this.ht+s,this.et+i],this.updateNodeLines()}onUp(t){if(0!=this.dt);else{for(const t of this.global.data.select??[])t.setSelected(!1);this.setSelected(!0)}}getConnector(t){return t in this.V?this.V[t]:null}addConnectorObject(t){t.assignToNode(this)}addSetPropCallback(t,s){this.lt[s]=t}getAllOutgoingLines(){return Object.values(this.V).flatMap((t=>t.outgoingLines))}getAllIncomingLines(){return Object.values(this.V).flatMap((t=>t.incomingLines))}getProp(t){return this.J[t]}setProp(t,s){if(t in this.lt&&this.lt[t](s),this.J[t]=s,!(t in this.V))return;const i=this.V[t].outgoingLines.filter((t=>t.target&&!t.v)).map((t=>t.target));if(i)for(const h of i){if(!h)continue;if(!h.parent)continue;h.parent.setProp(h.name,s)}}propagateProp(){for(const t of Object.values(this.V))this.setProp(t.name,this.getProp(t.name))}}G=new WeakMap,B=new WeakMap,t.Background=class extends dt{constructor(t,s){super(t,s),H(this,"_tileSize",40),this.event.global.pointerMove=this.moveBackground,this.dom.style={position:"absolute",top:"0",left:"0",backgroundSize:`${this.gt}px ${this.gt}px`},this.moveBackground()}moveBackground(t){var s,i,h,e;let n=null==(s=this.global.camera)?void 0:s.cameraPositionX,r=null==(i=this.global.camera)?void 0:i.cameraPositionY,l=5*(null==(h=this.global.camera)?void 0:h.cameraWidth),o=5*(null==(e=this.global.camera)?void 0:e.cameraHeight);this.worldPosition=[Math.floor(n/this.gt)*this.gt-l/2,Math.floor(r/this.gt)*this.gt-o/2],this.dom.style={width:`${l}px`,height:`${o}px`},this.requestPostWrite()}},t.BaseObject=ut,t.CameraControl=class extends dt{constructor(t,s=!1,i=!1){super(t,null),H(this,"_state","idle"),H(this,"_mouseDownX"),H(this,"_mouseDownY"),H(this,"zoomLock"),H(this,"panLock"),H(this,"resizeObserver",null),J(this,G,0),J(this,B,0),this.zoomLock=s,this.panLock=i,this.nt=0,this.rt=0,this.T="idle",this.event.global.pointerDown=this.onCursorDown,this.event.global.pointerMove=this.onCursorMove,this.event.global.pointerUp=this.onCursorUp,this.event.global.mouseWheel=this.onZoom,this.transformMode="direct",this.style={position:"absolute",left:"0px",top:"0px",width:"0px",height:"0px"},this.requestTransform("WRITE_2"),this.resizeObserver=null,V(this,G,0),V(this,B,0),this.global.snapline.event.containerElementAssigned=()=>{this.resizeObserver=new ResizeObserver((()=>{this.updateCameraCenterPosition(K(this,G),K(this,B)),this.paintCamera()})),this.resizeObserver.observe(this.global.containerElement),this.resizeObserver.observe(window.document.body)}}paintCamera(){var t,s,i;null==(t=this.global.camera)||t.updateCameraProperty(),null==(s=this.global.camera)||s.updateCamera(),this.style.transform=null==(i=this.global.camera)?void 0:i.canvasStyle,this.requestTransform("WRITE_2")}updateCameraCenterPosition(t=0,s=0){var i,h;null==(i=this.global.camera)||i.setCameraCenterPosition(t,s);const e=null==(h=this.global.camera)?void 0:h.getCameraCenterPosition();V(this,G,(null==e?void 0:e.x)||0),V(this,B,(null==e?void 0:e.y)||0),this.paintCamera()}setCameraPosition(t,s){var i;null==(i=this.global.camera)||i.setCameraPosition(t,s),this.paintCamera()}setCameraCenterPosition(t,s){var i;null==(i=this.global.camera)||i.setCameraCenterPosition(t,s),this.paintCamera()}getCameraCenterPosition(){var t;return(null==(t=this.global.camera)?void 0:t.getCameraCenterPosition())||{x:0,y:0}}onCursorDown(t){var s;1==t.event.button&&(this.panLock||(this.T="panning",this.nt=t.position.screenX,this.rt=t.position.screenY,null==(s=this.global.camera)||s.handlePanStart(),t.event.preventDefault()))}onCursorMove(t){var s,i;if("panning"!=this.T)return;const h=t.position.screenX-this.nt,e=t.position.screenY-this.rt;null==(s=this.global.camera)||s.handlePanDrag(h,e),this.style.transform=null==(i=this.global.camera)?void 0:i.canvasStyle,this.requestTransform("WRITE_2")}onCursorUp(t){var s,i,h;if("panning"!=this.T)return;this.T="idle",null==(s=this.global.camera)||s.handlePanEnd(),this.style.transform=null==(i=this.global.camera)?void 0:i.canvasStyle;const e=null==(h=this.global.camera)?void 0:h.getCameraCenterPosition();V(this,G,(null==e?void 0:e.x)||0),V(this,B,(null==e?void 0:e.y)||0),this.requestTransform("WRITE_2")}onZoom(t){var s,i;if(this.zoomLock)return;let h=this.global.camera;t.position.screenX<h.containerOffsetX||t.position.screenX>h.containerOffsetX+h.cameraWidth||t.position.screenY<h.containerOffsetY||t.position.screenY>h.containerOffsetY+h.cameraHeight||(null==(s=this.global.camera)||s.handleScroll(t.delta/2e3,t.position.cameraX,t.position.cameraY),this.style.transform=null==(i=this.global.camera)?void 0:i.canvasStyle,this.requestTransform("WRITE_2"),t.event.preventDefault())}},t.ConnectorComponent=Mt,t.ElementObject=dt,t.GlobalManager=Et,t.LineComponent=Wt,t.NodeComponent=yt,t.RectSelectComponent=class extends dt{constructor(t,s){super(t,s),H(this,"_state"),H(this,"_mouseDownX"),H(this,"_mouseDownY"),H(this,"_selectHitBox"),this.T="none",this.nt=0,this.rt=0,this.event.global.pointerDown=this.onGlobalCursorDown,this.event.global.pointerMove=this.onGlobalCursorMove,this.event.global.pointerUp=this.onGlobalCursorUp,this.bt=new wt(t,this,0,0,0,0),this.bt.transform.x=0,this.bt.transform.y=0,this.bt.event.collider.onCollide=this.onCollideNode,this.addCollider(this.bt),this.global.data.select=[],this.style={width:"0px",height:"0px",transformOrigin:"top left",position:"absolute",left:"0px",top:"0px",pointerEvents:"none"},this.requestWrite()}onGlobalCursorDown(t){if(!(0!==t.event.button||t.event.target&&"sl-background"!==t.event.target.id)){for(let t of this.global.data.select)t.setSelected(!1);this.global.data.select=[],this.worldPosition=[t.position.x,t.position.y],this.bt.recalculate(),this.T="dragging",this.style={display:"block",width:"0px",height:"0px"},this.nt=t.position.x,this.rt=t.position.y,this.bt.event.collider.onBeginContact=(t,s)=>{if(s.parent instanceof yt){s.parent.setSelected(!0)}},this.bt.event.collider.onEndContact=(t,s)=>{if(s.parent instanceof yt){s.parent.setSelected(!1)}}}}onGlobalCursorMove(t){if("dragging"===this.T){let[s,i]=[Math.min(this.nt,t.position.x),Math.min(this.rt,t.position.y)],[h,e]=[Math.abs(t.position.x-this.nt),Math.abs(t.position.y-this.rt)];this.style={width:`${h}px`,height:`${e}px`},this.worldPosition=[s,i],this.bt.transform.x=this.transform.x-s,this.bt.transform.y=this.transform.y-i,this.bt.transform.width=h,this.bt.transform.height=e,this.requestTransform()}}onGlobalCursorUp(t){this.style={display:"none"},this.T="none",this.bt.event.collider.onBeginContact=null,this.bt.event.collider.onEndContact=null,this.requestTransform()}onCollideNode(t,s){}},t.SnapLine=class{constructor(t={}){J(this,I),H(this,"snaplineConfig"),J(this,L,{}),H(this,"global"),H(this,"_collisionEngine",null),H(this,"_event"),H(this,"event"),H(this,"debug",!1),H(this,"debugWindow",null),H(this,"debugCtx",null),J(this,A,null),this.global=new Et,this.global.read1Queue={},this.global.write1Queue={},this.global.read2Queue={},this.global.write2Queue={},this.global.read3Queue={},this.global.write3Queue={},this.global.animationList=[],this.global.snapline=this;this.snaplineConfig={cameraConfig:{enableZoom:!0,enablePan:!0,panBounds:{top:null,left:null,right:null,bottom:null}},...t},V(this,L,{position:"relative",overflow:"hidden"}),this.global.collisionEngine=new Dt,this.q={containerElementAssigned:null},this.event=nt(this,this.q),this.debug=!1,V(this,A,new ResizeObserver((()=>{if(this.debug){let t=this.global.containerElement.getBoundingClientRect();this.debugWindow.width=t.width,this.debugWindow.height=t.height}})))}enableDebug(){if(null==this.global.containerElement)return;this.debug=!0,this.debugWindow=document.createElement("canvas"),this.debugWindow.style.position="absolute",this.debugWindow.style.top="0",this.debugWindow.style.left="0";let t=this.global.containerElement.getBoundingClientRect();this.debugWindow.width=t.width,this.debugWindow.height=t.height,this.debugWindow.style.zIndex="1000",this.debugWindow.style.pointerEvents="none",this.global.containerElement.appendChild(this.debugWindow),this.debugCtx=this.debugWindow.getContext("2d")}disableDebug(){this.debug=!1,this.debugWindow&&(this.debugWindow.remove(),this.debugWindow=null,this.debugCtx=null)}assignDom(t){var s,i,h;this.global.containerElement=t,this.global.camera=new st(t),null==(i=(s=this.event).containerElementAssigned)||i.call(s,t),null==(h=K(this,A))||h.observe(t),window.requestAnimationFrame(tt(this,I,O).bind(this))}debugObjectBoundingBox(t){var s,i,h;if(null==this.debugCtx)return;this.debugCtx.beginPath(),this.debugCtx.fillStyle="rgba(0, 0, 0, 0.5)";const[e,n]=(null==(s=this.global.camera)?void 0:s.getCameraFromWorld(...t.worldPosition))??[0,0];if(this.debugCtx.rect(e,n,20,20),this.debugCtx.fill(),this.debugCtx.fillStyle="white",this.debugCtx.fillText(t.gid,e,n+10),t.hasOwnProperty("_dom")){let s=t;const h=["#FF0000A0","#00FF00A0","#0000FFA0"],r=["READ_1","READ_2","READ_3"];for(let t=0;t<3;t++){const e=s.getDomProperty(r[t]);this.debugCtx.stroke(),this.debugCtx.beginPath(),this.debugCtx.strokeStyle=h[t],this.debugCtx.lineWidth=1;const[n,l]=(null==(i=this.global.camera)?void 0:i.getCameraFromWorld(e.x,e.y))??[0,0];this.debugCtx.rect(n,l,e.width,e.height),this.debugCtx.stroke()}this.debugCtx.beginPath(),this.debugCtx.strokeStyle="black",this.debugCtx.lineWidth=1,this.debugCtx.rect(e,n,s.t.property.width,s.t.property.height)}const r="rgba(0, 0, 255, 0.5)";for(let l of t.o){this.debugCtx.beginPath(),this.debugCtx.strokeStyle=r,this.debugCtx.lineWidth=1;const[s,i]=(null==(h=this.global.camera)?void 0:h.getCameraFromWorld(t.transform.x+l.transform.x,t.transform.y+l.transform.y))??[0,0];"circle"==l.type?(this.debugCtx.arc(s,i,l.radius,0,2*Math.PI),this.debugCtx.stroke()):"rect"==l.type?(this.debugCtx.rect(s,i,l.transform.width,l.transform.height),this.debugCtx.stroke()):"point"==l.type&&(this.debugCtx.arc(s,i,2,0,2*Math.PI),this.debugCtx.fillStyle=r,this.debugCtx.fill())}}renderDebugGrid(){if(null==this.debugCtx)return;const t=100,s=this.global.camera;if(!s)return;const[i,h]=s.getWorldFromCamera(0,0),[e,n]=s.getWorldFromCamera(this.debugWindow.width,this.debugWindow.height),r=Math.floor(i/t)*t,l=Math.ceil(e/t)*t,o=Math.floor(h/t)*t,a=Math.ceil(n/t)*t;this.debugCtx.beginPath(),this.debugCtx.strokeStyle="rgba(200, 200, 200, 0.3)",this.debugCtx.lineWidth=1;for(let f=r;f<=l;f+=t){const[t,i]=s.getCameraFromWorld(f,h),[e,r]=s.getCameraFromWorld(f,n);this.debugCtx.moveTo(t,i),this.debugCtx.lineTo(e,r)}for(let f=o;f<=a;f+=t){const[t,h]=s.getCameraFromWorld(i,f),[n,r]=s.getCameraFromWorld(e,f);this.debugCtx.moveTo(t,h),this.debugCtx.lineTo(n,r)}this.debugCtx.stroke(),this.debugCtx.beginPath(),this.debugCtx.strokeStyle="rgba(0, 0, 0, 0.8)",this.debugCtx.lineWidth=2;const u=r<=0&&l>=0;if(o<=0&&a>=0){const[t,i]=s.getCameraFromWorld(r,0),[h,e]=s.getCameraFromWorld(l,0);this.debugCtx.moveTo(t,i),this.debugCtx.lineTo(h,e)}if(u){const[t,i]=s.getCameraFromWorld(0,o),[h,e]=s.getCameraFromWorld(0,a);this.debugCtx.moveTo(t,i),this.debugCtx.lineTo(h,e)}this.debugCtx.stroke(),this.debugCtx.fillStyle="rgba(0, 0, 0, 0.8)",this.debugCtx.font="12px Arial",this.debugCtx.textAlign="center";for(let f=r;f<=l;f+=t){if(0===f)continue;const[t,i]=s.getCameraFromWorld(f,0);i>=0&&i<=this.debugWindow.height&&this.debugCtx.fillText(f.toString(),t,i+20)}for(let f=o;f<=a;f+=t){if(0===f)continue;const[t,i]=s.getCameraFromWorld(0,f);t>=0&&t<=this.debugWindow.width&&this.debugCtx.fillText(f.toString(),t-20,i+4)}const[c,d]=s.getCameraFromWorld(0,0);c>=0&&c<=this.debugWindow.width&&d>=0&&d<=this.debugWindow.height&&this.debugCtx.fillText("(0,0)",c+20,d-10)}renderDebugFrame(t){var s,i;if(null!=this.debugWindow){null==(s=this.debugCtx)||s.clearRect(0,0,this.debugWindow.width,this.debugWindow.height),this.renderDebugGrid();for(const t of Object.values(this.global.objectTable))this.debugObjectBoundingBox(t);if(null!=this.debugCtx){for(const t of Object.values(this.global.debugMarkerList)){const[s,h]=(null==(i=this.global.camera)?void 0:i.getCameraFromWorld(t.x,t.y))??[0,0];"point"==t.type?(this.debugCtx.beginPath(),this.debugCtx.fillStyle=t.color,this.debugCtx.arc(s,h,5,0,2*Math.PI),this.debugCtx.fill()):"rect"==t.type?(this.debugCtx.beginPath(),this.debugCtx.fillStyle=t.color,this.debugCtx.rect(s,h,t.width,t.height),this.debugCtx.fill()):"circle"==t.type?(this.debugCtx.beginPath(),this.debugCtx.fillStyle=t.color,this.debugCtx.arc(s,h,t.radius,0,2*Math.PI),this.debugCtx.fill()):"text"==t.type&&(this.debugCtx.fillStyle=t.color,this.debugCtx.fillText(t.text,s,h))}for(const t in this.global.debugMarkerList)this.global.debugMarkerList[t].persistent||delete this.global.debugMarkerList[t]}}}K(){var t;let s={timestamp:Date.now()};this.global.currentStage="READ_1",tt(this,I,P).call(this,"READ_1",this.global.read1Queue),this.global.read1Queue={},this.global.currentStage="WRITE_1",tt(this,I,P).call(this,"WRITE_1",this.global.write1Queue),this.global.write1Queue={},this.global.currentStage="READ_2",tt(this,I,P).call(this,"READ_2",this.global.read2Queue),this.global.read2Queue={},this.global.currentStage="WRITE_2",tt(this,I,P).call(this,"WRITE_2",this.global.write2Queue),this.global.write2Queue={};let i=[];for(const h of this.global.animationList)0==h.calculateFrame(s.timestamp)&&0==h.requestDelete&&i.push(h);this.global.animationList=i,this.global.currentStage="READ_3",tt(this,I,P).call(this,"READ_3",this.global.read3Queue),this.global.read3Queue={},this.global.currentStage="WRITE_3",tt(this,I,P).call(this,"WRITE_3",this.global.write3Queue),this.global.write3Queue={},this.global.currentStage="IDLE",null==(t=this.global.collisionEngine)||t.detectCollisions(),this.renderDebugFrame(s)}},Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}));
